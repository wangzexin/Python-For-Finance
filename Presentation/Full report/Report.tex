% This is a comment.
% the region directly below this comment, up till the command \begin{document} is known as the 'preamble'
% basic setup
\documentclass[12pt]{article}
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}

% for mathematics
\usepackage{amsmath}
\usepackage{amsthm}
% define theorems, lemmas, etc
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{corollary}{Corollary}
\newtheorem{definition}{Definition}
\newtheorem{example}{Example}
\usepackage{amssymb}

% for adjusting margins
\usepackage{geometry}
\geometry{
	a4paper,
 	left=26mm,
 	right=20mm,
 	top=33mm,
 	bottom=38mm
}

% for introducing urls
\usepackage{url}

% for colored text
\usepackage{color}

% for creating lists
\usepackage{enumerate}

% change font to times new roman
\usepackage{times}

% include algorithm package
\usepackage[]{algorithm2e}

%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% the region between \begin{document} ... \end{document} is known as the 'text'
\begin{document}
\begin{titlepage}
	\centering
	\vspace*{.09\textheight}
	{\LARGE\bfseries Undergraduate Research Opportunity\\
Programme in Science\par}
	\vspace{1.5cm}
	{\huge Financial Mathematics With Python\par}
	\vspace{1cm}
	{\scshape\Large Wang Zexin\par}
	\vspace{6cm}
	{\LARGE\scshape Zhou Chao\par}
	\vspace{3cm}
	{\Large Department of Mathematics\\[3mm]
National University of Singapore\\[3mm]
AY2016/17 Semester 2\par}
\end{titlepage}

\tableofcontents
\newpage

\section*{Abstract}
In this paper, we implemented the library packages for Python to solve problems in Financial Mathematics such as derivatives valuation and simulation as suggested by the book ``\emph{Python for Finance}''. Those results correspond to the different approaches in pricing financial derivatives. The key effort is on the development of valuation scheme for the options, in particular, the strongly path-dependent options. More importantly, our model is open to extend for various assumptions about the market. We attempt to apply these valuation schemes onto the path-independent options with available closed-form formulain order to verify the valuation results from Monte Carlo simulations as well as the Finite Difference Model.

\section{Introduction}
The study upon using Python to carry out derivatives valuation has made much progress over the years as there have already been available libraries built for this purpose. The derivatives analytics library suggested in the book ``\emph{Python for Finance}'' has its advantages on the coverage upon the various aspects of possible analysis for financial derivatives. Still, we can make justifiable modifications and extensions to improve on the accuracy and speed of computations for estimations. 
\\

\newpage

\section{Derivation of Black Scholes PDE}

\subsection{Basics}
\begin{center}
In the Black-Scholes World, we assume that the following two SDE hold:
$$dM_{t}  = rM_{t}dt$$
$$dS_{t}  = \mu S_{t}dt + \sigma S_{t} dW_{t}$$

We assume that the It$\hat{o}^{\prime}$s Lemma hold:\\[4mm]
As $dS_{t} = \mu S_{t}dt + \sigma S_{t}dW_{t}$,
$$dV_{t} = (\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S})dt + \frac{\partial V}{\partial S}dS_{t}$$
\end{center}
\newpage

\subsection{Delta-hedging Argument}

\begin{center}
Our first aim is to find $\phi_{t}$\\[1mm]
for $\mathrm{\Pi}_{t} = V_{t} - \phi_{t}S_{t}$\\[3mm]
such that\\[1mm]
$d\mathrm{\Pi}_{t} = dV_{t} - \phi_{t}dS_{t}$(Self-financing)\\[1mm]
$d\mathrm{\Pi}_{t} = r\mathrm{\Pi}_{t}dt$(risk free)\\[3mm]
From the equations, we can obtain that\\[1mm]
$r\mathrm{\Pi}_{t}dt = dV_{t} - \phi_{t}dS_{t}$\\[1mm]
$r(V_{t} - \phi_{t}S_{t})dt = dV_{t} - \phi_{t}dS_{t}$\\[1mm]
$dV_{t}  = r(V_{t} - \phi_{t}S_{t})dt + \phi_{t}dS_{t}$\\[1mm]
By It$\hat{o}^{\prime}$s Lemma, $$dV_{t} = (\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S})dt + \frac{\partial V}{\partial S}dS_{t}$$
Hence we obtain two equations:
$$\phi_{t} = \frac{\partial V}{\partial S}$$
$$r(V_{t} - \phi_{t}S_{t}) = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}$$
\end{center}

\begin{center}
$$r(V_{t} - \frac{\partial V}{\partial S}S_{t}) = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}$$
$$\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S} + r\frac{\partial V}{\partial S}S_{t} - rV_{t} = 0$$
At time t, we have
$$\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S^{2}\frac{\partial V}{\partial S} + r\frac{\partial V}{\partial S}S - rV = 0$$
\end{center}
\newpage

\subsection{Replicating portfolio}

\begin{center}
Our aim is to find $a_{t}$ and $b_{t}$ such that $\mathrm{\Pi}_{t} = a_{t}S_{t} + b_{t}M_{t}$ can entirely replicate $V_{t}$\\[2mm]
while the self-financing condition still holds: $d\mathrm{\Pi}_{t} = a_{t}dS_{t} + b_{t}dM_{t}$\\[5mm]
As $dS_{t} = \mu S_{t}dt + \sigma S_{t}dW_{t}$ and $dM_{t}  = rM_{t}dt$,
\begin{equation*}
\begin{split}
d\mathrm{\Pi}_{t} 
&= a_{t}(\mu S_{t}dt + \sigma S_{t}dW_{t}) + b_{t}(rM_{t}dt)\\
&= (a_{t}\mu S_{t} + rb_{t}M_{t})dt + (\sigma a_{t}S_{t})dW_{t}\\
\end{split}
\end{equation*}
\end{center}

\begin{center}
By It$\hat{o}^{\prime}$s Lemma, 
\begin{equation*}
\begin{split}
dV_{t}
&= (\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S})dt + \frac{\partial V}{\partial S}dS_{t}\\
&= (\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S})dt + \frac{\partial V}{\partial S}(\mu S_{t}dt + \sigma S_{t}dW_{t})\\
&= (\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+\frac{\partial V}{\partial S}\mu S_{t})dt + (\sigma S_{t}\frac{\partial V}{\partial S})dW_{t}\\
\end{split}
\end{equation*}
\end{center}

\begin{center}
As $\mathrm{\Pi}_{t}$ fully replicates $V_{t}$,
$$d\mathrm{\Pi}_{t} = (a_{t}\mu S_{t} + rb_{t}M_{t})dt + (\sigma a_{t}S_{t})dW_{t} = dV_{t}$$
Also by It$\hat{o}^{\prime}$s Lemma, 
$$dV_{t} = (\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+\frac{\partial V}{\partial S}\mu S_{t})dt + (\sigma S_{t}\frac{\partial V}{\partial S})dW_{t}$$
Hence we obtain that,
$$a_{t} = \frac{\partial V}{\partial S}$$
$$a_{t}\mu S_{t} + rb_{t}M_{t} = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+\frac{\partial V}{\partial S}\mu S_{t}$$
\end{center}

\begin{center}
$$\frac{\partial V}{\partial S}\mu S_{t} + rb_{t}M_{t} = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+\frac{\partial V}{\partial S}\mu S_{t}$$
$$rb_{t}M_{t} = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}$$
$$ra_{t}S_{t}+rb_{t}M_{t} = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+ra_{t}S_{t}$$
$$rV_{t} = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+r\frac{\partial V}{\partial S}S_{t}$$
$$\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+r\frac{\partial V}{\partial S}S_{t}- rV_{t} = 0$$
Hence,
$$\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S^{2}\frac{\partial V}{\partial S}+r\frac{\partial V}{\partial S}S- rV = 0$$
\end{center}
\newpage
\subsection{Lognormal property}
We shall derive the lognormal property of the underlying asset prices.
As given by the Geometric Brownian Motion, $dS_{t}  = \mu S_{t}dt + \sigma S_{t} dW_{t}$.\\
We can define the derivative price function as $V(S_{t}, t) := \ln{S_{t}}$, with \\
$$\frac{\partial V}{\partial S} = \frac{1}{S}, \frac{\partial^{2} V}{\partial S^{2}} = -\frac{1}{S^{2}} , \frac{\partial V}{\partial t} = 0$$
By It$\hat{o}^{\prime}$s Lemma,
\begin{equation}
\begin{split}
dV_{t}
&= ((\mu S_{t})\frac{\partial V}{\partial S} + \frac{\partial V}{\partial t} + \frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial^{2} V}{\partial S^{2}})dt + b\frac{\partial V}{\partial S}dW_{t}\\
&= (\mu - \frac{1}{2}\sigma^{2})dt + \sigma dW_{t}
\end{split}
\end{equation}
As $\mu$ and $\sigma$ are constants, $V_{t}$ is simply a drifted Brownian Motion.\\
$$V_{t} - V_{0} = \ln{S_{t}} - \ln{S_{0}} \sim \mathcal{N}((\mu - \frac{1}{2}\sigma^{2})t, \sigma^{2}t)$$
$$\frac{\ln{S_{t}} - \ln{S_{0}} - (\mu - \frac{1}{2}\sigma^{2})t}{\sigma\sqrt{t}} \sim \mathcal{N}(0,1)$$
We can also generalize to the case for time $t$ and $T$. (Let $\tau = T - t$, $\phi \sim \mathcal{N}(0,1)$)
$$\frac{\ln{S_{T}} - \ln{S_{t}} - (\mu - \frac{1}{2}\sigma^{2})\tau}{\sigma\sqrt{\tau}} = \phi $$
$$S_{T} = S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi}$$
\newpage

\section{Finite Difference Model for Numerical PDE}
$$\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S^{2}\frac{\partial V}{\partial S}+r\frac{\partial V}{\partial S}S- rV = 0$$
If we are to plot out the option prices in a diagram, there should be a 3D diagram with y-axis being the underlying prices, and x-axis being the time, omitting the scenario when the option price is dependent on other stochastic terms such as volatility.
In the Black-Scholes formula, we are able to approximate $\Theta = \frac{\partial V}{\partial t}$, $\Delta = \frac{\partial V}{\partial S}$ and $\Gamma = \frac{\partial^{2} V}{\partial S^{2}}$ when the discretization is significantly small and thus it will be easy to simply use the ratio of change in derivatives value with respect to change in time or change in underlying asset value.\\
$$\frac{\partial V}{\partial t} \approx \frac{P_{t} - P_{t-{^{\Delta}t}}}{^{\Delta}t}$$
$$\frac{\partial V}{\partial S} \approx \frac{P_{S} - P_{S-{^{\Delta}S}}}{^{\Delta}S} \approx \frac{P_{S+{^{\Delta}S}} - P_{S}}{^{\Delta}S}$$
\begin{equation}
\begin{split}
\frac{\partial^{2} V}{\partial S^{2}}
&\approx \frac{\partial}{\partial V}(\frac{P_{S+{^{\Delta}S}} - P_{S}}{^{\Delta}S})\\
&\approx \frac{\frac{P_{S+{^{\Delta}S}} - P_{S}}{^{\Delta}S} - \frac{P_{S} - P_{S-{^{\Delta}S}}}{^{\Delta}S}}{^{\Delta}S}\\
&= \frac{P_{S+{^{\Delta}S}} - 2P_{S} + P_{S-{^{\Delta}S}}}{(^{\Delta}S)^{2}}
\end{split}
\end{equation}

\subsection{One factor model using Implicit Scheme}
\newpage
\subsection{Explicit Scheme}
The difference between explicit and implicit scheme lies in the need to solve an implicit equation at each discretization or there is a closed-form formula for each step.
\newpage
\subsection{Feynman–Kac formula}
\newpage
\subsection{Crank–Nicolson method}
\newpage

\section{Variance Reduction Techniques for Monte Carlo Simulation}
Monte Carlo simulations are usually used when there is no readily available closed-form formula and the numerical PDE valuation scheme is not developed yet. However, people have already explored its strenght upon the valuation using high-dimensional scheme. When doing option pricing with Monte Carlo simulations, we simulate a series of possible scenarios and use the payoff function to calculate one option payoff. By repeating this process $N$ times and take the average of all the discounted option payoffs, a more accurate option price can be obtained. When there is time variation in parameters of the model, or the option payoff is path dependent, or there are a number of stochastic variables that the option price depends on, a finite difference scheme will be both space and time consuming. With the advancements of GPU and parallel computing, just as suggestd in the book ``\emph{Python for Finance}'', the power of Monte Carlo is able to emerge.\\
As the simulated option payoffs may scatter all over the real number axis, for example when European call option has a particularly low strike price, the variance of the simulated option payoffs can be so large that the accuracy of the valuation is compromised. In order to prevent this from happening, we adopt many different methods to reduce the variance while keeping the estimate unbiased.
\newpage
\subsection{Control Variate}
Control Variate is one of the most common methods adopted for the purpose of variance reduction in simulations. Assuming all the $Y_{i}$ are realizations of the same variable $Y$, i.e. $\forall  i, Y_{i}$ follows identical and independent distributions. Our aim is to estimate $\mathrm{E}[Y_{i}]$ \\
Under simulation, we use $\bar{Y} = \frac{1}{n} \sum_{i=1}^{n} Y_{i}$ as an estimate of $\mathrm{E}[Y_{i}]$.
Now we introduce a new variable $X$, with realizations $X_{i}, \forall i $ such that $1 \leq i \leq n$\\
Define the new simulated results $Y_{i}(\lambda) = Y_{i} - \lambda (X_{i} - \mathrm{E}(X))$
$$\bar{Y}(\lambda) = \bar{Y} - \lambda (\bar{X} - \mathrm{E}(X)) = \frac{1}{n} \sum_{i=1}^{n} [Y_{i} - \lambda (X_{i} - \mathrm{E}(X))]$$
The new estimate $\bar{Y}(\lambda)$ is unbiased and consistent as proven below.\\
$$\mathrm{E}(\bar{Y}(\lambda)) = \mathrm{E}[\bar{Y} - \lambda(\bar{X} - \mathrm{E}(X))] = \mathrm{E}(\bar{Y}) - \lambda(\mathrm{E}(\bar{X}) - \mathrm{E}(X)) = \mathrm{E}(Y) $$
\begin{equation*}
\begin{split}
\lim_{n\to\infty} \frac{1}{n}\sum_{i=1}^{n} Y_{i}(\lambda) 
&=\lim_{n\to\infty} \frac{1}{n}\sum_{i=1}^{n} [Y_{i} - \lambda (X_{i} - \mathrm{E}(X))] \\
&= \mathrm{E}[Y - \lambda(X-\mathrm{E}(X))] \\
&= \mathrm{E}(Y) \\
\end{split}
\end{equation*}
We can first express the variance of each new simulated result as:
\begin{equation*}
\begin{split}
\mathrm{Var}[Y_{i}(\lambda)]
&=\mathrm{Var} [Y_{i} - \lambda(X_{i} - \mathrm{E}(X))] \\
&= \mathrm{Var}[Y_{i} - \lambda X_{i}] \\
&= \mathrm{Var}(Y_{i}) + \lambda^{2}\mathrm{Var}(X_{i}) - 2\lambda\mathrm{Cov}(X_{i}, Y_{i}) \\
&= \sigma_{Y}^{2} + \lambda^{2}\sigma_{X}^{2}-2\lambda\sigma_{X}\sigma_{Y}\rho_{XY}\\
\end{split}
\end{equation*}
In order to find the minimum variance by varying $\lambda$\\[2mm]
Set $\frac{\partial \mathrm{Var}[Y_{i}(\lambda)]}{\partial \lambda} = 2\lambda \sigma_{X}^{2} - 2\sigma_{X}\sigma_{Y}\rho_{XY}$ to 0, $ \lambda^{*} = \frac{2\sigma_{X}\sigma_{Y}\rho_{XY}}{2\sigma_{X}^{2}} = \frac{\sigma_{X}\sigma_{Y}\rho_{XY}}{\sigma_{X}^{2}} = \frac{\mathrm{Cov}(X,Y)}{\mathrm{Var}(X)}$\\
Compare the new variance with the old:
\begin{equation*}
\begin{split}
\frac{\mathrm{Var} [Y_{i} - \lambda^{*}(X_{i} - \mathrm{E}(X))]}{\mathrm{Var}(Y)}
&=\frac{\sigma_{Y}^{2} + {\lambda^{*}}^{2}\sigma_{X}^{2}-2\lambda^{*}\sigma_{X}\sigma_{Y}\rho_{XY}}{\sigma_{Y}^{2}} \\
&=1+\frac{\frac{\mathrm{Var}(X)(\mathrm{Cov}(X,Y))^{2}}{(\mathrm{Var}(X))^{2}}-\frac{2(\mathrm{Cov}(X,Y))^{2}}{\mathrm{Var}(X)}}{\sigma_{Y}^{2}}\\
&=1+\frac{\frac{\sigma_{X}^{4}\sigma_{Y}^{2}\rho_{XY}^{2}}{\sigma_{X}^{4}}-\frac{2\sigma_{X}^{2}\sigma_{Y}^{2}\rho_{XY}^{2}}{\sigma_{X}^{2}}}{\sigma_{Y}^{2}}\\
&=1+\frac{\sigma_{Y}^{2}\rho_{XY}^{2}-2\sigma_{Y}^{2}\rho_{XY}^{2}}{\sigma_{Y}^{2}}\\
&=1-\rho_{XY}^{2}\\
\end{split}
\end{equation*}
A $100(1-\alpha)\%$ Confidence Interval is $ [\bar{Y}(\lambda) - \mathcal{Z}_{1-\alpha/2} \frac{\hat{\sigma}_{n, Y_{\lambda}}}{\sqrt{n}}, \bar{Y}(\lambda) + \mathcal{Z}_{1-\alpha/2} \frac{\hat{\sigma}_{n, Y_{\lambda}}}{\sqrt{n}}]$\\
\newpage
As a conclusion from the theoretical results, we shall see that the stronger the correlation, the better the reduction in variance. We can use random variables with stronger correlation with the option payoffs as the control variates, such as underlying asset prices, tractable option prices, bond prices.\\
In the case that it is not feasible to calculate using the probability distribution of $X$ and $Y$, we should work $\lambda^{*}$ out as an estimate using a pilot simulation.\\[5mm]
\begin{algorithm}[H]
 \KwData{Scenarios for simulations of $X$ and $Y$}
 \KwResult{Estimation for $\mathrm{E}(Y)$}
 initialization\;
 assign N to be the number of simulations to do\;
 pilot simulation to obtain correlation\;
 \For {i = 1 \dots N} {
 \quad $generate(X_{i}, Y_{i})$\;
 }
 Assign $\lambda^{*} = \frac{\mathrm{Cov}(X,Y)}{\mathrm{Var}(X)} = \frac{\sum_{i=1}^{n}(X_{i}-\bar{X})(Y_{i}-\bar{Y})}{\sum_{i=1}^{n}(X_{i}-\bar{X})^{2}}$\;
 \For {i = 1 \dots N} {
	\quad $generate(X_{i}, Y_{i})$\;
	\quad set ${Y}_{i}(\lambda) = Y_{i} + \lambda^{*}(X_{i}-\mathrm{E}[X])$\;
 }
 $\bar{Y}(\lambda) = \frac{1}{n} \sum_{i=1}^{n} {Y}_{i}(\lambda)$\;
\caption{General Control Variate Algorithm}
\end{algorithm}
Here we put down the algorithm for Monte Carlo simulations of option prices using underlying prices as control variates. Denote the underlying prices by $U_{i}$, payoff function by $f$, option payoffs by $P_{i}$ and the option premium by $\bar{P}(\lambda)$.\\[5mm]
\begin{algorithm}[H]
 \KwData{Scenarios for simulations of $U$ and $P$}
 \KwResult{Estimation for $\mathrm{E}(P)$}
 initialization\;
 assign N to be the number of simulations to do\;
 \For {i = 1 \dots N} {
  \quad $generate(U_{i})$\;
  \quad $P_{i} = f(U_{i})$\;
 }
 Assign $\lambda^{*} = \frac{\mathrm{Cov}(U, P)}{\mathrm{Var}(U)} = \frac{\sum_{i=1}^{n}(U_{i}-\bar{U})(P_{i}-\bar{P})}{\sum_{i=1}^{n}(U_{i}-\bar{U})^{2}}$\;
 \For {i = 1 \dots N} {
  \quad $generate(U_{i})$\;
  \quad $P_{i} = f(U_{i})$\;
  \quad set ${P}_{i}(\lambda) = P_{i} + \lambda^{*}(U_{i}-\mathrm{E}[U])$\;
 }
 $\bar{P}(\lambda) = e^{-rT}\frac{1}{n} \sum_{i=1}^{n} {P}_{i}(\lambda)$\;
\caption{General Control Variate Algorithm}
\end{algorithm}
\newpage
\subsection{Stratified Sampling}
Stratified sampling refers broadly to any sampling mechanism that constrains the fraction of observations drawn from specific subsets (or strata) of the sample space. Our goal is to estimate $\mathrm{E}[Y]$, by dividing the sample space into $n$ parts, with $A_{1}, \dots ,A_{n}$ being disjoint subsets of the real line for which $\mathrm{P}(Y \in \cup_{i}A_{i}) = 1$. \\
By Bayes$^{\prime}$ Theorem, $ \mathrm{E}[Y] = \sum_{i=1}^{n}\mathrm{P}(Y \in A_{i})\mathrm{E}[Y|Y \in A_{i}] = \sum_{i=1}^{n}p_{i}\mathrm{E}[Y|Y \in A_{i}] $\\
We shall exercise proportional sampling which is the simplest case, ensuring $p_{i} = \mathrm{P}(Y \in A_{i})$, the fraction of observations drawn from stratum $A_{i}$ exactly matches theoretical probability.\\[1mm]
Unbiased estimator of $\mathrm{E}(Y)$ is given by $\hat{Y} = \sum_{i=1}^{K} (p_{i} \frac{1}{n_{i}} \sum_{j=1}^{n_{i}} Y_{ij}) = \frac{1}{n} \sum_{i=1}^{K} \sum_{j=1}^{n_{i}} Y_{ij}$
$$ \mathrm{E}[\hat{Y}] = \mathrm{E}[\sum_{i=1}^{K} (p_{i} \frac{1}{n_{i}} \sum_{j=1}^{n_{i}} Y_{ij})] = \sum_{i=1}^{K}\mathrm{P}(Y \in A_{i})\mathrm{E}[Y|Y \in A_{i}] = \mathrm{E}[Y]$$
We shall generate a stratification variable $X$ which take values in the union of the disjoint sets $A_{i}$s. As supposedly the values of $X$ are high correlated to the values of $Y$, in many cases, $Y$ is a function of X. Let $X$ be the discrete path of underlying asset prices, with $Y$ being the European call payoff discounted to time 0. If $X$ has $h$ discrete prices on one path, $\Omega \in \mathbb{R}^{h}$ is the sample space for the $X_{i}^{\prime}$s, where $\Omega = \cup_{i} A_{i}$ is the union of disjoint sets.\\
For the purpose of stratified sampling, $\mathbb{P}(X \in A_{i})$ and $Y | X \in A_{i}$ should be easy to generate.\\
In order to further simplify the trouble of dividing $\Omega$ into disjoint subsets, we are going to use the stock prices at time $\frac{T}{2}$ as the condition to determine the distributions of $A_{i}$. The stock prices at time $\frac{T}{2}$ will be computed based on the Geometric Brownian Motion of the underlying stock prices. Given that we are to produce $n$ equally probable subsets of $\Omega$, the standard normal distribution can be sliced into $n$ pieces to provide sources of generation. With the underlying asset prices at time $\frac{T}{2}$, we can generate $k$ prices at time $T$ and calculate the respective option payoffs. The average payoffs for each stratum $A_{i}$ is then computed and discounted back to time $\frac{T}{2}$, at which we calculate the average payoffs across the stratum and discount to time $0$. \\[2mm]
\begin{algorithm}[H]
 \KwData{$N$ the number of total simulations and $f$ the payoff function}
 \KwResult{$\bar{P}$, Estimation for the option premium}
 initialization\;
 $k = \frac{N}{n}$ is the number of simulations for each stratum\;
 \For {i = 1 \dots n} {
 $z_{\alpha_{i}}$ is the quantile of standard normal distribution at probability $\frac{i}{n}$\;
 $S_{\frac{T}{2}, i} = S_{0}\exp\{(r-\frac{1}{2}\sigma^{2})\frac{T}{2} + \sigma \sqrt{\frac{T}{2}}z_{\alpha_{i}}\}$\;
 \For {j = 1 \dots k} {
 \quad $S_{T, i, j} = S_{\frac{T}{2}, i}\exp\{(r-\frac{1}{2}\sigma^{2})\frac{T}{2} + \sigma \sqrt{\frac{T}{2}}z_{i,j}\}$\;
 \quad $P_{T, i, j} = f(S_{T, i, j})$;
 \quad }
 $\bar{P}_{\frac{T}{2}, i} = \frac{1}{k} e^{-r\frac{T}{2}}  \sum_{j=1}^{k} P_{T, i, j}$\;
 }
 $\bar{P} = \frac{1}{n} \sum_{i=1}^{n} \bar{P}_{\frac{T}{2}, i}$\;
\caption{General Proportional Sampling Algorithm}
\end{algorithm}
\newpage
\subsection{Importance Sampling}
Importance sampling is a method to reduce variance by changing the probability measure. The word 'Importance' comes from the aim to give more weight to 'important' outcomes by changing measures.\\
We are going to estimate $\alpha = \mathrm{E}[h(X)] = \int h(x)f(x) dx$.\\
In Monte Carlo simulation, $\hat{\alpha} = \hat{\alpha}(n) = \frac{1}{n} \sum_{i=1}^{n} h(X_{i})$\\
By using a change of measure based on the following assumption:
$\forall x \in \mathbb{R}^{d}, f(x) > 0 \implies g(x) > 0$\\
Now the estimate becomes $\alpha = \mathrm{E}[h(X)] = \mathrm{E}[h(X)\frac{f(X)}{g(X)}] = \int h(x)\frac{f(x)}{g(x)} dx$\\
And for simulation, $\hat{\alpha}_{G} = \frac{1}{n} \sum_{i=1}^{n} h(X_{i})\frac{f(X_{i})}{g(X_{i})}$
We are choosing $g$ to make ${X \in A}$ more likely after changing measure.\\
In order to reduce variance, we need to implicitly find the $g$ which gives the minimum possible variance. According to the variance formula $\mathrm{Var}(X) = \mathrm{E}(X^{2}) - (\mathrm{E}(X))^{2} $, we have\\
\begin{equation*}
\begin{split}
\mathrm{Var}^{G}[h(X)\frac{f(X)}{g(X)}] &= \mathrm{E}^{G}[h(X)^{2}\frac{f(X)^{2}}{g(X)^{2}}] - (\mathrm{E}^{G}[h(X)\frac{f(X)}{g(X)}])^{2}\\
&= \int \frac{h(x)^{2}f(x)^{2}}{g(x)} dx - (\int \frac{h(x)f(x)}{g(x)}g(x) dx)^{2}\\
\end{split}
\end{equation*}
Here if $h(x) = \frac{g(x)f(x)}{\mathrm{E}(g(x))}$, the variance of estimate will become 0.\\
Consider the scenario in which we simulate discrete price paths $S(t_{i}), \forall i = 0, 1, \dots, m$, which is assumed to be a Markov Chain with homogeneous property. Let the continuous transition probability be $f_{i}(S(t_{i-1}),S(t_{i}))$.\\[3mm]
We shall use likelihood ratio $\prod_{i=1}^{m} \frac{f_{i}(S(t_{i-1}),S(t_{i}))}{g_{i}(S(t_{i-1}),S(t_{i}))}$ as risk-neutral measure.
\begin{equation*}
\begin{split}
\mathbb{E}^{\mathbb{Q}}(X) 
&= \int x g(x) dx\\
&= \mathbb{E}^{\mathbb{P}}(\frac{d\mathbb{Q}}{d\mathbb{P}}X) \\
&= \mathbb{E}^{\mathbb{P}}(e^{\lambda W_{T} - \frac{1}{2}\lambda^{2}T}X) \\[7mm]
\end{split}
\end{equation*}
Our aim is to make (where $A>0$)
$$\mathbb{E}^{\mathbb{P}}((S_{T} - K)^{+})= \mathbb{E}^{\mathbb{Q}}(\frac{d\mathbb{P}}{d\mathbb{Q}}(S_{T} - K)^{+}) = \mathbb{E}^{\mathbb{Q}}(e^{((\mu - \frac{\sigma^{2}}{2}+\sigma A)T + \sigma W_{T}^{\mathbb{Q}}})(S_{T} - K)^{+})$$\\[4mm]
Hence $\frac{d\mathbb{Q}}{d\mathbb{P}} = exp\{AW_{T} - \frac{1}{2}A^{2}T\}$
\newpage
\section{European call options}
\subsection{Closed-form formula}
We can derive the closed-form formula for the European call options using risk-neutral pricing.\\
Payoff function of the European call option is : $c_{T} = (S_{T} - K)^{+}$\\
By the risk-neutral pricing formula,
\begin{equation}
\begin{split}
e^{-\mu t}c_{t}
&= \mathbb{E}^{Q}[e^{-\mu T}c_{T} | \mathcal{F}_{t}]\\
&= \mathbb{E}_{t}^{Q}[e^{-\mu T}(S_{T} - K)^{+}]
\end{split}
\end{equation}
By the lognormal property, \quad
$S_{T} = S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi}$
\begin{equation}
\begin{split}
c_{t} 
&= e^{\mu t}\mathbb{E}_{t}^{Q}[e^{-rT}(S_{T} - K)^{+}]\\
&= e^{\mu t}\mathbb{E}_{t}^{Q}[e^{-rT}(S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi} - K)^{+}]\\
&= e^{-\mu \tau}\mathbb{E}^{Q}[(S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi} - K)^{+}]\\
&= e^{-\mu \tau}\int_{-\infty}^{\infty} (S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi} - K)^{+}\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}  \, d\phi \\
&= e^{-\mu \tau}\int_{-d_{2}}^{\infty} (S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi} - K)\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}  \, d\phi \\
&= e^{-\mu \tau}\int_{-d_{2}}^{\infty} S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi}\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}  \, d\phi - e^{-r\tau}\int_{-d_{2}}^{\infty} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}K\, d\phi\\
&= e^{(\mu - \frac{1}{2}\sigma^{2})\tau-\mu \tau}S_{t}\int_{-d_{2}}^{\infty} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}(\phi^{2}-2\sigma\sqrt{\tau}\phi)}  \, d\phi - Ke^{-r\tau}\int_{-d_{2}}^{\infty} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi\\
&= S_{t}\int_{-d_{2}}^{\infty} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}(\phi^{2}-2\sigma\sqrt{\tau}\phi+\sigma^{2}\tau)}  \, d\phi - Ke^{-r\tau}\int_{-\infty}^{d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi\\
&= S_{t}\int_{-d_{2}}^{\infty} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}(\phi-\sigma\sqrt{\tau}\phi)^{2}}  \, d\phi - Ke^{-r\tau}\int_{-\infty}^{d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi\\
&= S_{t}\int_{-d_{2}-\sigma\sqrt{\tau}}^{\infty} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}y^{2}}  \, dy - Ke^{-r\tau}\int_{-\infty}^{d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi\\
&= S_{t}\int_{-\infty}^{d_{2}+\sigma\sqrt{\tau}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}y^{2}}  \, dy - Ke^{-r\tau}\int_{-\infty}^{d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi\\
&= S_{t} N(d_{1}) - Ke^{-r\tau} N(d_{2})
\end{split}
\end{equation}
where,
$$d_{2} = \frac{\ln{\frac{S_{t}}{K}} + (\mu - \frac{1}{2}\sigma^{2})\tau}{\sigma\sqrt{\tau}}$$
$$d_{1} = d_{2} + \sigma\sqrt{\tau}$$
Also, $N$ is the cumulative density function of standard normal function.
\newpage
\subsection{Numerical PDE}
\newpage
\subsection{Monte Carlo Simulation}
With the following settings: $\sigma = 0.25$, $\mu = 0.05$, $T = 1$, $S_{0} = 100$, 
when we compare the results from Monte Carlo simulation with the option prices computed using the closed form formula, it is observable that a simulation with 500000 data points still has variation of error within range from $-0.02$ to $0.02$. However, this comparison has ensured that our valuation scheme using Monte Carlo simulation and the variance reduction techniques is on the right way, and may be applied onto other options.\\
A tabulation of the resultant option prices are shown below:
\begin{center}
\begin{tabular}{|c|c|c|}
\hline
Closed-form formula & Ordinary Monte Carlo & Control Variate\\
\hline
10.0022021172&10.005252032814727& 10.005252032814751\\
8.02638469385&8.0166707887876427& 8.016670788787664\\ 
6.37924904693&6.3659464432937911& 6.3659464432937733\\ 
5.02541348179&5.0148870431746415& 5.0148870431746184\\
3.92690420603&3.9241698581683577& 3.9241698581683728\\
3.04592058431&3.044679765401427&  3.0446797654014213\\
2.34679877596&2.3310307686205207& 2.3310307686205225\\
1.79723400902&1.8055531375480696& 1.8055531375480751\\
1.36889248498&1.3630119824610754& 1.3630119824610734\\
1.03756650489&1.0254470920297398& 1.0254470920297361\\
0.783018613011&0.77819086371547286&0.77819086371547308\\
0.588637155719&0.5924848566970754& 0.59248485669707973\\
0.440997057228&0.44342591182216823&0.4434259118221664\\
0.329392108384&0.32449718396190719&0.32449718396190735\\
0.245381782063&0.2462392632801686& 0.24623926328016907\\
0.182377553986&0.17995020687354496&0.1799502068735449\\
0.13528073067&0.13478417666883458&0.13478417666883413\\
0.100175092579&0.099449778570450814&0.099449778570450523\\
0.0740722950356&0.074452813719303179&0.074452813719303304\\
0.0547050187389&0.051631534936688268&0.051631534936688074\\
\hline
\end{tabular}
\end{center}
\newpage

\section{European put options}

\subsection{Closed-form formula}
We can derive the closed-form formula for the European put options using risk-neutral pricing.\\
Payoff function of the European put option is : $p_{T} = (K - S_{T})^{+}$\\
By the risk-neutral pricing formula,
\begin{equation}
\begin{split}
e^{-\mu t}p_{t}
&= \mathbb{E}^{Q}[e^{-\mu T}p_{T} | \mathcal{F}_{t}]\\
&= \mathbb{E}_{t}^{Q}[e^{-\mu T}(K - S_{T})^{+}]
\end{split}
\end{equation}
By the lognormal property, \quad
$S_{T} = S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi}$
\begin{equation}
\begin{split}
p_{t} 
&= e^{\mu t}\mathbb{E}_{t}^{Q}[e^{-rT}(K - S_{T})^{+}]\\
&= e^{\mu t}\mathbb{E}_{t}^{Q}[e^{-rT}(K - S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi})^{+}]\\
&= e^{-\mu \tau}\mathbb{E}^{Q}[(K - S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi})^{+}]\\
&= e^{-\mu \tau}\int_{-\infty}^{\infty} (K - S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi})^{+}\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}  \, d\phi \\
&= e^{-\mu \tau}\int_{-\infty}^{-d_{2}} (K - S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi})\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}  \, d\phi \\
&= e^{-r\tau}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}K\, d\phi -e^{-\mu \tau}\int_{-\infty}^{-d_{2}} S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi}\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}  \, d\phi\\
&= Ke^{-r\tau}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi - e^{(\mu - \frac{1}{2}\sigma^{2})\tau-\mu \tau}S_{t}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}(\phi^{2}-2\sigma\sqrt{\tau}\phi)}  \, d\phi\\
&= Ke^{-r\tau}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi - S_{t}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}(\phi^{2}-2\sigma\sqrt{\tau}\phi+\sigma^{2}\tau)}  \, d\phi\\
&= Ke^{-r\tau}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi - S_{t}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}(\phi-\sigma\sqrt{\tau}\phi)^{2}}  \, d\phi\\
&= Ke^{-r\tau}\int_{-\infty}^{d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi - S_{t}\int_{-\infty}^{-d_{2}-\sigma\sqrt{\tau}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}y^{2}}  \, dy\\
&= Ke^{-r\tau}\int_{-\infty}^{d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi - S_{t}\int_{-\infty}^{-d_{1}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}y^{2}}  \, dy \\
&= Ke^{-r\tau} N(-d_{2}) - S_{t} N(-d_{1})
\end{split}
\end{equation}
where,
$$d_{2} = \frac{\ln{\frac{S_{t}}{K}} + (\mu - \frac{1}{2}\sigma^{2})\tau}{\sigma\sqrt{\tau}}$$
$$d_{1} = d_{2} + \sigma\sqrt{\tau}$$
Also, $N$ is the cumulative density function of standard normal function.
\newpage
\subsection{Numerical PDE}
\newpage
\subsection{Monte Carlo Simulation}
With the following settings: $\sigma = 0.25$, $\mu = 0.05$, $T = 1$, $S_{0} = 100$, 
when we compare the results from Monte Carlo simulation with the option prices computed using the closed form formula, it is observable that a simulation with 500000 data points still has variation of error within range from $-0.02$ to $0.02$. However, this comparison has ensured that our valuation scheme using Monte Carlo simulation and the variance reduction techniques is on the right way, and may be applied onto other options.\\
A tabulation of the resultant option prices are shown below:
\begin{center}
\begin{tabular}{|c|c|c|}
\hline
Closed-form formula & Ordinary Monte Carlo & Control Variate\\
\hline
9.88129168973 &9.89121100448 & 9.89121100448 \\
12.6616213889 &12.6718073072 & 12.6718073072 \\
15.7706328645 &15.7786013449 & 15.7786013449 \\
19.1729444219 &19.1488969419 & 19.1488969419 \\
22.8305822686 &22.8396769379 & 22.8396769379 \\
26.7057457694 &26.7349375768 & 26.7349375768 \\
30.7627710836 &30.7487677853 & 30.7487677853 \\
34.9693534391 &34.9407041949 & 34.9407041949 \\
39.2971590376 &39.3339188168 & 39.3339188168 \\
43.72198018 &  43.6672929866 & 43.6672929866 \\
48.2235794106 &48.2561306956 & 48.2561306956 \\
52.7853450758 &52.7364667849 & 52.7364667849 \\
57.3938520998 &57.3635053884 & 57.3635053884 \\
62.0383942735 &62.0538619165 & 62.0538619165 \\
66.7105310697 &66.7099933687 & 66.7099933687 \\
71.4036739641 &71.3460094069 & 71.3460094069 \\
76.1127242633 &76.1619698093 & 76.1619698093 \\
80.8337657477 &80.8390739688 & 80.8390739688 \\
85.5638100727 &85.5359768969 & 85.5359768969 \\
90.3005899189 &90.2678714265 & 90.2678714265 \\
\hline
\end{tabular}
\end{center}
\newpage

\section{Barrier option}

\subsection{Closed-form formula}
\newpage
\subsection{Numerical PDE}
\newpage
\subsection{Monte Carlo Simulation}
\newpage

\end{document}