% This is a comment.
% the region directly below this comment, up till the command \begin{document} is known as the 'preamble'
% basic setup
\documentclass[12pt]{article}
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}

% for mathematics
\usepackage{amsmath}
\usepackage{amsthm}
% define theorems, lemmas, etc
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{corollary}{Corollary}
\newtheorem{definition}{Definition}
\newtheorem{example}{Example}
\usepackage{amssymb}

% for adjusting margins
\usepackage{geometry}
\geometry{
	a4paper,
 	left=26mm,
 	right=20mm,
 	top=33mm,
 	bottom=38mm
}

% for introducing urls
\usepackage{url}

% for colored text
\usepackage{color}

% for creating lists
\usepackage{enumerate}

% change font to times new roman
\usepackage{times}

% include algorithm package
\usepackage[]{algorithm2e}

% include bbm package to support indicator variable
\usepackage{bbm}

%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% the region between \begin{document} ... \end{document} is known as the 'text'
\begin{document}
\begin{titlepage}
	\centering
	\vspace*{.09\textheight}
	{\LARGE\bfseries Undergraduate Research Opportunity\\
Programme in Science\par}
	\vspace{1.5cm}
	{\huge Financial Mathematics With Python\par}
	\vspace{1cm}
	{\scshape\Large Wang Zexin\par}
	\vspace{6cm}
	{\LARGE\scshape Zhou Chao\par}
	\vspace{3cm}
	{\Large Department of Mathematics\\[3mm]
National University of Singapore\\[3mm]
AY2016/17 Semester 2\par}
\end{titlepage}

\tableofcontents
\newpage

\section*{Abstract}
In this paper, we implemented the library packages for Python to solve problems in Financial Mathematics such as derivatives valuation and simulation as suggested by the book ``\emph{Python for Finance}''. Those results correspond to the different approaches in pricing financial derivatives. The key effort is on the development of valuation scheme for the options, in particular, the strongly path-dependent options. More importantly, our model is open to extend for various assumptions about the market. We attempt to apply these valuation schemes onto the path-independent options with available closed-form formulain order to verify the valuation results from Monte Carlo simulations as well as the Finite Difference Model.

\section{Introduction}
The study upon using Python to carry out derivatives valuation has made much progress over the years as there have already been available libraries built for this purpose. The derivatives analytics library suggested in the book ``\emph{Python for Finance}'' has its advantages on the coverage upon the various aspects of possible analysis for financial derivatives. Still, we can make justifiable modifications and extensions to improve on the accuracy and speed of computations for estimations. 
\\

\newpage

\section{Derivation of Black Scholes PDE}

\subsection{Basics}
\begin{center}
In the Black-Scholes World, we assume that the following two SDE hold:
$$dM_{t}  = rM_{t}dt$$
$$dS_{t}  = \mu S_{t}dt + \sigma S_{t} dW_{t}$$

We assume that the It$\hat{o}^{\prime}$s Lemma hold:\\[4mm]
As $dS_{t} = \mu S_{t}dt + \sigma S_{t}dW_{t}$,
$$dV_{t} = (\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S})dt + \frac{\partial V}{\partial S}dS_{t}$$
\end{center}
\newpage

\subsection{Delta-hedging Argument}

\begin{center}
Our first aim is to find $\phi_{t}$\\[1mm]
for $\mathrm{\Pi}_{t} = V_{t} - \phi_{t}S_{t}$\\[3mm]
such that\\[1mm]
$d\mathrm{\Pi}_{t} = dV_{t} - \phi_{t}dS_{t}$(Self-financing)\\[1mm]
$d\mathrm{\Pi}_{t} = r\mathrm{\Pi}_{t}dt$(risk free)\\[3mm]
From the equations, we can obtain that\\[1mm]
$r\mathrm{\Pi}_{t}dt = dV_{t} - \phi_{t}dS_{t}$\\[1mm]
$r(V_{t} - \phi_{t}S_{t})dt = dV_{t} - \phi_{t}dS_{t}$\\[1mm]
$dV_{t}  = r(V_{t} - \phi_{t}S_{t})dt + \phi_{t}dS_{t}$\\[1mm]
By It$\hat{o}^{\prime}$s Lemma, $$dV_{t} = (\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S})dt + \frac{\partial V}{\partial S}dS_{t}$$
Hence we obtain two equations:
$$\phi_{t} = \frac{\partial V}{\partial S}$$
$$r(V_{t} - \phi_{t}S_{t}) = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}$$
\end{center}

\begin{center}
$$r(V_{t} - \frac{\partial V}{\partial S}S_{t}) = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}$$
$$\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S} + r\frac{\partial V}{\partial S}S_{t} - rV_{t} = 0$$
At time t, we have
$$\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S^{2}\frac{\partial V}{\partial S} + r\frac{\partial V}{\partial S}S - rV = 0$$
\end{center}
\newpage

\subsection{Replicating portfolio}

\begin{center}
Our aim is to find $a_{t}$ and $b_{t}$ such that $\mathrm{\Pi}_{t} = a_{t}S_{t} + b_{t}M_{t}$ can entirely replicate $V_{t}$\\[2mm]
while the self-financing condition still holds: $d\mathrm{\Pi}_{t} = a_{t}dS_{t} + b_{t}dM_{t}$\\[5mm]
As $dS_{t} = \mu S_{t}dt + \sigma S_{t}dW_{t}$ and $dM_{t}  = rM_{t}dt$,
\begin{equation*}
\begin{split}
d\mathrm{\Pi}_{t} 
&= a_{t}(\mu S_{t}dt + \sigma S_{t}dW_{t}) + b_{t}(rM_{t}dt)\\
&= (a_{t}\mu S_{t} + rb_{t}M_{t})dt + (\sigma a_{t}S_{t})dW_{t}\\
\end{split}
\end{equation*}
\end{center}

\begin{center}
By It$\hat{o}^{\prime}$s Lemma, 
\begin{equation*}
\begin{split}
dV_{t}
&= (\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S})dt + \frac{\partial V}{\partial S}dS_{t}\\
&= (\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S})dt + \frac{\partial V}{\partial S}(\mu S_{t}dt + \sigma S_{t}dW_{t})\\
&= (\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+\frac{\partial V}{\partial S}\mu S_{t})dt + (\sigma S_{t}\frac{\partial V}{\partial S})dW_{t}\\
\end{split}
\end{equation*}
\end{center}

\begin{center}
As $\mathrm{\Pi}_{t}$ fully replicates $V_{t}$,
$$d\mathrm{\Pi}_{t} = (a_{t}\mu S_{t} + rb_{t}M_{t})dt + (\sigma a_{t}S_{t})dW_{t} = dV_{t}$$
Also by It$\hat{o}^{\prime}$s Lemma, 
$$dV_{t} = (\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+\frac{\partial V}{\partial S}\mu S_{t})dt + (\sigma S_{t}\frac{\partial V}{\partial S})dW_{t}$$
Hence we obtain that,
$$a_{t} = \frac{\partial V}{\partial S}$$
$$a_{t}\mu S_{t} + rb_{t}M_{t} = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+\frac{\partial V}{\partial S}\mu S_{t}$$
\end{center}

\begin{center}
$$\frac{\partial V}{\partial S}\mu S_{t} + rb_{t}M_{t} = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+\frac{\partial V}{\partial S}\mu S_{t}$$
$$rb_{t}M_{t} = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}$$
$$ra_{t}S_{t}+rb_{t}M_{t} = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+ra_{t}S_{t}$$
$$rV_{t} = \frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+r\frac{\partial V}{\partial S}S_{t}$$
$$\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial V}{\partial S}+r\frac{\partial V}{\partial S}S_{t}- rV_{t} = 0$$
Hence,
$$\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S^{2}\frac{\partial V}{\partial S}+r\frac{\partial V}{\partial S}S- rV = 0$$
\end{center}
\newpage
\subsection{Lognormal property}
We shall derive the lognormal property of the underlying asset prices.
As given by the Geometric Brownian Motion, $dS_{t}  = \mu S_{t}dt + \sigma S_{t} dW_{t}$.\\
We can define the derivative price function as $V(S_{t}, t) := \ln{S_{t}}$, with \\
$$\frac{\partial V}{\partial S} = \frac{1}{S}, \frac{\partial^{2} V}{\partial S^{2}} = -\frac{1}{S^{2}} , \frac{\partial V}{\partial t} = 0$$
By It$\hat{o}^{\prime}$s Lemma,
\begin{equation}
\begin{split}
dV_{t}
&= ((\mu S_{t})\frac{\partial V}{\partial S} + \frac{\partial V}{\partial t} + \frac{1}{2}\sigma^{2}S_{t}^{2}\frac{\partial^{2} V}{\partial S^{2}})dt + b\frac{\partial V}{\partial S}dW_{t}\\
&= (\mu - \frac{1}{2}\sigma^{2})dt + \sigma dW_{t}
\end{split}
\end{equation}
As $\mu$ and $\sigma$ are constants, $V_{t}$ is simply a drifted Brownian Motion.\\
$$V_{t} - V_{0} = \ln{S_{t}} - \ln{S_{0}} \sim \mathcal{N}((\mu - \frac{1}{2}\sigma^{2})t, \sigma^{2}t)$$
$$\frac{\ln{S_{t}} - \ln{S_{0}} - (\mu - \frac{1}{2}\sigma^{2})t}{\sigma\sqrt{t}} \sim \mathcal{N}(0,1)$$
We can also generalize to the case for time $t$ and $T$. (Let $\tau = T - t$, $\phi \sim \mathcal{N}(0,1)$)
$$\frac{\ln{S_{T}} - \ln{S_{t}} - (\mu - \frac{1}{2}\sigma^{2})\tau}{\sigma\sqrt{\tau}} = \phi $$
$$S_{T} = S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi}$$
\newpage

\section{Finite Difference Model for Numerical PDE}
The advantages of using a Finite Difference valuation scheme over Monte Carlo simulations lie in the fact that there have been a lot of well-developed models for the known problems, and the generally lower computation costs.\\
In this report, we have only implemented one-factor models and two-factor models, in which the original Black-Scholes model, Merton's Jump-diffusion model, and Heston's Stochastic Volatility model can be incorporated. With these models above, we are able to give valuation schemes for European options, Barrier options, Asian options. However the more complicated options such as Multi-asset options will require the usage of multiple-factor models.
$$\frac{\partial V}{\partial t}+\frac{1}{2}\sigma^{2}S^{2}\frac{\partial V}{\partial S}+r\frac{\partial V}{\partial S}S- rV = 0$$
If we are to plot out the option prices in a diagram, there should be a 3D diagram with y-axis being the underlying prices, and x-axis being the time, omitting the scenario when the option price is dependent on other stochastic terms such as volatility.
In the Black-Scholes formula, we are able to approximate $\Theta = \frac{\partial V}{\partial t}$, $\Delta = \frac{\partial V}{\partial S}$ and $\Gamma = \frac{\partial^{2} V}{\partial S^{2}}$ when the discretization is significantly small and thus it will be easy to simply use the ratio of change in derivatives value with respect to change in time or change in underlying asset value.\\
$$\frac{\partial V}{\partial t} \approx \frac{P_{t} - P_{t-{^{\Delta}t}}}{^{\Delta}t}$$
$$\frac{\partial V}{\partial S} \approx \frac{P_{S} - P_{S-{^{\Delta}S}}}{^{\Delta}S} \approx \frac{P_{S+{^{\Delta}S}} - P_{S}}{^{\Delta}S}$$
\begin{equation}
\begin{split}
\frac{\partial^{2} V}{\partial S^{2}}
&\approx \frac{\partial}{\partial V}(\frac{P_{S+{^{\Delta}S}} - P_{S}}{^{\Delta}S})\\
&\approx \frac{\frac{P_{S+{^{\Delta}S}} - P_{S}}{^{\Delta}S} - \frac{P_{S} - P_{S-{^{\Delta}S}}}{^{\Delta}S}}{^{\Delta}S}\\
&= \frac{P_{S+{^{\Delta}S}} - 2P_{S} + P_{S-{^{\Delta}S}}}{(^{\Delta}S)^{2}}
\end{split}
\end{equation}
The three most popular approximation schemes to the time derivative are the explicit and implicit Euler, and Crank-Nicolson schemes. The first two are of first-order accuracy, and the last one has second-order accuracy.
\newpage

\subsection{One factor model using Explicit Scheme}
We first define the payoff function as a function of the individual price path and other inherent parameters of the options such as strike price. For the boundary conditions, if we are to assume that the Black-Scholes PDE to be satisfied at $S = 0$, giving $\frac{\partial V}{\partial t} = rV$can be easily solved, suggesting that $V$ is exponentially related to $rT$. In light of this, we can have an exact solution and therefore a Dirichlet boundary condition at $S = 0$. For the purpose of option pricing, the PDE is always defined on a semi-infinite domain, which can be fitted onto our implementation with programming using the transformation $x = \log{S}$ onto the real line or $x = \frac{S}{S+K}$ onto $(0, 1)$as suggested by Wilmott.\\
Here we omit the mathematical proofs and give an algorithm of exercising explicit scheme in the finite difference model. With the input variables $r$ as the continuous compounding interest rate, $\sigma$ as the volatility, $S$ as the current underlying asset price, $f$ as the payoff function for the option, $T$ as the time to maturity and $M$ as the number of underlying asset price differences required.\\
We are to denote the discrete time points $0 \to T$ using incides from $1,2 \dots N$, and to denote the discrete underlying asset price points $0 \to 2S$ using incides from $1,2, \dots M$\\[2mm]
\begin{algorithm}[H]
 \KwData{$r, \sigma, S, f, T, M$}
 \KwResult{$V_{\frac{M}{2},1}$, option premium}
 Initialization\;
 let $\delta S = \frac{2S}{M}$ be the underlying asset price difference \;
 For stability, let $\delta t = \frac{0.9}{\sigma^{2}M^{2}}$ be the time difference\;
 $N = \frac{T}{\delta t}$\;
 We define the following vectors:\\
 $\alpha_{i} = \frac{1}{2}\delta t(\sigma^{2}i^{2} - ri), \beta_{i} = 1-\delta t(\sigma^{2}i^{2} + r), \gamma_{i} = \frac{1}{2}\delta t(\sigma^{2}i^{2} + ri), \forall \, 1 \le i \le M$\;
 Set the boundary conditions\;
 \For {i = 1 \dots M} {
  $V_{i, N} = f(i\,\delta S)$\;
 }
 \For {j = 1 \dots N} {
  $V_{M, j} = f(2S)e^{-r(N-j)\delta t}$\;
 }
 \For {j = N \dots 1} {
  \For {i = 2 \dots M-1} {
   $V_{i, j-1} = \sigma_{i}V_{i-1,j} + \beta_{i}V_{i,j} + \gamma_{i}V_{i+1,j} $\;
  }
 }
 $V_{\frac{M}{2},1}$ is the output value for option premium\;
\caption{One factor Explicit scheme FDM algorithm}
\end{algorithm}
In the case that $\frac{M}{2}$ is not integral, interpolation to find a more accurate value is needed.\\[1mm]
In short, the equation can be expressed as:
$$V_{i, j-1} = \sigma_{i}V_{i-1,j} + \beta_{i}V_{i,j} + \gamma_{i}V_{i+1,j},  \forall \,2 \le i \le M-1, \forall \,1 \le j \le N-1$$
$$\alpha_{i} = \frac{1}{2}\delta t(\sigma^{2}i^{2} - ri), \beta_{i} = 1-\delta t(\sigma^{2}i^{2} + r), \gamma_{i} = \frac{1}{2}\delta t(\sigma^{2}i^{2} + ri), \forall 1 \le i \le M$$
\newpage
\subsection{One factor model using Implicit Scheme}
The greatest difference between explicit and implicit scheme lies in the need to solve an implicit equation at each discretization or there is a closed-form formula for each step.
Here we give an algorithm of exercising implicit scheme in the finite difference model. Similar to the previous section, with the input variables $r$ as the continuous compounding interest rate, $\sigma$ as the volatility, $S$ as the current underlying asset price, $f$ as the payoff function for the option, $T$ as the time to maturity and $M$ as the number of underlying asset price differences required.\\
We are to denote the discrete time points $0 \to T$ using incides from $1,2 \dots N$, and to denote the discrete underlying asset price points $0 \to 2S$ using incides from $1,2, \dots M$\\[2mm]
\begin{algorithm}[H]
 \KwData{$r, \sigma, S, f, T, M$}
 \KwResult{$V_{\frac{M}{2},1}$, option premium}
 Initialization\;
 let $\delta S = \frac{2S}{M}$ be the underlying asset price difference \;
 For stability, let $\delta t = \frac{0.9}{\sigma^{2}M^{2}}$ be the time difference\;
 $N = \frac{T}{\delta t}$\;
 We define the following vectors:\\
 $\alpha_{i} = \frac{1}{2}\delta t(\sigma^{2}i^{2} - ri), \beta_{i} = 1-\delta t(\sigma^{2}i^{2} + r), \gamma_{i} = \frac{1}{2}\delta t(\sigma^{2}i^{2} + ri), \forall \, 1 \le i \le M$\;
 We build the tridiagonal matrix $A$ using $\alpha, \beta, \gamma$\;
 Let $L$ and $U$ be the LU-decomposition of $A$\;
 Set the boundary conditions\;
 \For {i = 1 \dots M} {
  $V_{i, N} = f(i\,\delta S)$\;
 }
 \For {j = 1 \dots N} {
  $V_{M, j} = f(2S)e^{-r(N-j)\delta t}$\;
 }
 let $e$ be a zero vector with dimension $(M-1) \times 1$\;
 \For {j = N \dots 1} {
  $e_{1} = \alpha_{2} V_{1, j}$\;
  $temp =  V_{2:M, j+1} - e$\;
  $tempMatrix =  L$ \textbackslash $temp$\;
  $V_{2:M, j} = U$ \textbackslash $\,tempMatrix$\;
 }
 $V_{\frac{M}{2},1}$ is the desired option premium\;
\caption{One factor Implicit scheme FDM algorithm}
\end{algorithm}
In accordance with the matrix computations, the implicit equation to solve is as follows:
$$V_{i, j+1} = \alpha_{i}V_{i-1,j} + \beta_{i}V_{i,j} + \gamma_{i}V_{i+1,j}$$
$$\alpha_{i} = \frac{1}{2}\delta t(ri-\sigma^{2}i^{2}), \beta_{i} = 1+\delta t(\sigma^{2}i^{2} + r), \gamma_{i} = \frac{1}{2}\delta t(-\sigma^{2}i^{2} - ri), \forall 1 \le i \le M$$
\newpage
\subsection{Feynman–Kac formula}
\newpage
\subsection{Crank–Nicolson method}
On the grid of nodes $V_{s,t}$ where $s$ stands for the underlying asset prices and $t$ stands for the time, the Explicit Euler scheme prices the node $V_{s,t-1}$ based on the values of $V_{s-1,t}$, $V_{s,t}$ and $V_{s+1,t}$, and the Implicit Euler scheme prices the nodes $V_{s-1,t-1}$, $V_{s,t-1}$ and $V_{s+1,t-1}$ based on the value of $V_{s,t}$. Similar to the Implicit Euler scheme, the Crank-Nicolson method prices all the three nodes $V_{s-1,t-1}$, $V_{s,t-1}$ and $V_{s+1,t-1}$ based on the values of $V_{s-1,t}$, $V_{s,t}$ and $V_{s+1,t}$.\\
As a result from the central approximation for $\displaystyle \frac{\partial V}{\partial t}$ and $\displaystyle \frac{\partial V}{\partial S}$ and standard approximation for $\displaystyle \frac{\partial^{2} V}{\partial S^{2}}$,
$$\frac{\partial V_{s, t-\frac{1}{2}}}{\partial t} \approx \frac{V_{s,t}-V_{s,t-1}}{\delta t}, \quad \frac{\partial V_{s, t-\frac{1}{2}}}{\partial S} \approx \frac{1}{2}[\frac{V_{s+1,t-1}-V_{s-1,t-1}}{2\delta S} + \frac{V_{s+1,t}-V_{s-1,t}}{2\delta S}]$$
$$\frac{\partial^{2} V_{s, t-\frac{1}{2}}}{\partial S^{2}} \approx \frac{1}{2}[\frac{V_{s+1,t-1}-2V_{s,t-1}+V_{s-1,t-1}}{\delta S^{2}} + \frac{V_{s+1,t}-2V_{s,t}+V_{s-1,t}}{\delta S^{2}}]$$
The implicit equation to solve is as follows:
$$-\alpha_{s}V_{s-1,t-1} + (1-\beta_{s})V_{s,t-1} - \gamma_{s}V_{s+1,t-1} = \alpha_{s}V_{s-1,t} + (1+\beta_{s})V_{s,t} + \gamma_{s}V_{s+1,t}$$
$$\alpha_{s} = \frac{\delta t}{4}(\sigma^{2}s^{2} - rs), \beta_{s} = -\frac{\delta t}{2}(\sigma^{2}s^{2} + r), \gamma_{s} = \frac{\delta t}{4}(\sigma^{2}s^{2} + rs)$$
For the convenience of computations, we still use matrix computations with adjustments at the boundaries.\\
\begin{algorithm}[H]
 \KwData{$r, \sigma, S, f, T, M$}
 \KwResult{$V_{\frac{M}{2},1}$, option premium}
 let $\delta S = \frac{2S}{M}$ be the underlying asset price difference \;
 For stability, let $\delta t = \frac{0.9}{\sigma^{2}M^{2}}$ be the time difference\;
 $N = \frac{T}{\delta t}$\;
 We define the following vectors:\\
 $\alpha_{i} = \frac{1}{2}\delta t(\sigma^{2}i^{2} - ri), \beta_{i} = 1-\delta t(\sigma^{2}i^{2} + r), \gamma_{i} = \frac{1}{2}\delta t(\sigma^{2}i^{2} + ri), \forall \, 1 \le i \le M$\;
 We build the tridiagonal matrix $A$ and $B$ with $-\alpha, 1-\beta, -\gamma$ and $\alpha, 1+\beta, \gamma$ on diagonals\;
 Let $L$ and $U$ be the LU-decomposition of $A$\;
 \For {i = 1 \dots M} {
  $V_{i, N} = f(i\,\delta S)$\;
 }
 \For {j = 1 \dots N} {
  $V_{M, j} = f(2S)e^{-r(N-j)\delta t}$\;
 }
 let $e$ be a zero vector with dimension $(M-1) \times 1$\;
 \For {j = N-1 \dots 1} {
  $e_{1} = \alpha_{2}(V_{1,i}+V_{1,i+1}), e_{M} = \gamma_{M}(V_{M,i}+V_{M,i+1})$\;
  $V_{2:M, j} = U$ \textbackslash $(L$\textbackslash$(D V_{2:M,j}+e))$\;
 }
 $V_{\frac{M}{2},1}$ is the desired option premium\;
\caption{Crank-Nicolson method FDM algorithm}
\end{algorithm}
\newpage

\section{Variance Reduction Techniques for Monte Carlo Simulation}
Monte Carlo simulations are usually used when there is no readily available closed-form formula and the numerical PDE valuation scheme is not developed yet. However, people have already explored its strenght upon the valuation using high-dimensional scheme. When doing option pricing with Monte Carlo simulations, we simulate a series of possible scenarios and use the payoff function to calculate one option payoff. By repeating this process $N$ times and take the average of all the discounted option payoffs, a more accurate option price can be obtained. When there is time variation in parameters of the model, or the option payoff is path dependent, or there are a number of stochastic variables that the option price depends on, a finite difference scheme will be both space and time consuming. With the advancements of GPU and parallel computing, just as suggestd in the book ``\emph{Python for Finance}'', the power of Monte Carlo is able to emerge.\\
As the simulated option payoffs may scatter all over the real number axis, for example when European call option has a particularly low strike price, the variance of the simulated option payoffs can be so large that the accuracy of the valuation is compromised. In order to prevent this from happening, we adopt many different methods to reduce the variance while keeping the estimate unbiased.
\newpage
\subsection{Control Variate}
Control Variate is one of the most common methods adopted for the purpose of variance reduction in simulations. Assuming all the $Y_{i}$ are realizations of the same variable $Y$, i.e. $\forall  i, Y_{i}$ follows identical and independent distributions. Our aim is to estimate $\mathrm{E}[Y_{i}]$ \\
Under simulation, we use $\bar{Y} = \frac{1}{n} \sum_{i=1}^{n} Y_{i}$ as an estimate of $\mathrm{E}[Y_{i}]$.
Now we introduce a new variable $X$, with realizations $X_{i}, \forall i $ such that $1 \leq i \leq n$\\
Define the new simulated results $Y_{i}(\lambda) = Y_{i} - \lambda (X_{i} - \mathrm{E}(X))$
$$\bar{Y}(\lambda) = \bar{Y} - \lambda (\bar{X} - \mathrm{E}(X)) = \frac{1}{n} \sum_{i=1}^{n} [Y_{i} - \lambda (X_{i} - \mathrm{E}(X))]$$
The new estimate $\bar{Y}(\lambda)$ is unbiased and consistent as proven below.\\
$$\mathrm{E}(\bar{Y}(\lambda)) = \mathrm{E}[\bar{Y} - \lambda(\bar{X} - \mathrm{E}(X))] = \mathrm{E}(\bar{Y}) - \lambda(\mathrm{E}(\bar{X}) - \mathrm{E}(X)) = \mathrm{E}(Y) $$
\begin{equation*}
\begin{split}
\lim_{n\to\infty} \frac{1}{n}\sum_{i=1}^{n} Y_{i}(\lambda) 
&=\lim_{n\to\infty} \frac{1}{n}\sum_{i=1}^{n} [Y_{i} - \lambda (X_{i} - \mathrm{E}(X))] \\
&= \mathrm{E}[Y - \lambda(X-\mathrm{E}(X))] \\
&= \mathrm{E}(Y) \\
\end{split}
\end{equation*}
We can first express the variance of each new simulated result as:
\begin{equation*}
\begin{split}
\mathrm{Var}[Y_{i}(\lambda)]
&=\mathrm{Var} [Y_{i} - \lambda(X_{i} - \mathrm{E}(X))] \\
&= \mathrm{Var}[Y_{i} - \lambda X_{i}] \\
&= \mathrm{Var}(Y_{i}) + \lambda^{2}\mathrm{Var}(X_{i}) - 2\lambda\mathrm{Cov}(X_{i}, Y_{i}) \\
&= \sigma_{Y}^{2} + \lambda^{2}\sigma_{X}^{2}-2\lambda\sigma_{X}\sigma_{Y}\rho_{XY}\\
\end{split}
\end{equation*}
In order to find the minimum variance by varying $\lambda$\\[2mm]
Set $\frac{\partial \mathrm{Var}[Y_{i}(\lambda)]}{\partial \lambda} = 2\lambda \sigma_{X}^{2} - 2\sigma_{X}\sigma_{Y}\rho_{XY}$ to 0, $ \lambda^{*} = \frac{2\sigma_{X}\sigma_{Y}\rho_{XY}}{2\sigma_{X}^{2}} = \frac{\sigma_{X}\sigma_{Y}\rho_{XY}}{\sigma_{X}^{2}} = \frac{\mathrm{Cov}(X,Y)}{\mathrm{Var}(X)}$\\
Compare the new variance with the old:
\begin{equation*}
\begin{split}
\frac{\mathrm{Var} [Y_{i} - \lambda^{*}(X_{i} - \mathrm{E}(X))]}{\mathrm{Var}(Y)}
&=\frac{\sigma_{Y}^{2} + {\lambda^{*}}^{2}\sigma_{X}^{2}-2\lambda^{*}\sigma_{X}\sigma_{Y}\rho_{XY}}{\sigma_{Y}^{2}} \\
&=1+\frac{\frac{\mathrm{Var}(X)(\mathrm{Cov}(X,Y))^{2}}{(\mathrm{Var}(X))^{2}}-\frac{2(\mathrm{Cov}(X,Y))^{2}}{\mathrm{Var}(X)}}{\sigma_{Y}^{2}}\\
&=1+\frac{\frac{\sigma_{X}^{4}\sigma_{Y}^{2}\rho_{XY}^{2}}{\sigma_{X}^{4}}-\frac{2\sigma_{X}^{2}\sigma_{Y}^{2}\rho_{XY}^{2}}{\sigma_{X}^{2}}}{\sigma_{Y}^{2}}\\
&=1+\frac{\sigma_{Y}^{2}\rho_{XY}^{2}-2\sigma_{Y}^{2}\rho_{XY}^{2}}{\sigma_{Y}^{2}}\\
&=1-\rho_{XY}^{2}\\
\end{split}
\end{equation*}
A $100(1-\alpha)\%$ Confidence Interval is $ [\bar{Y}(\lambda) - \mathcal{Z}_{1-\alpha/2} \frac{\hat{\sigma}_{n, Y_{\lambda}}}{\sqrt{n}}, \bar{Y}(\lambda) + \mathcal{Z}_{1-\alpha/2} \frac{\hat{\sigma}_{n, Y_{\lambda}}}{\sqrt{n}}]$\\
\newpage
As a conclusion from the theoretical results, we shall see that the stronger the correlation, the better the reduction in variance. We can use random variables with stronger correlation with the option payoffs as the control variates, such as underlying asset prices, tractable option prices, bond prices.\\
In the case that it is not feasible to calculate using the probability distribution of $X$ and $Y$, we should work $\lambda^{*}$ out as an estimate using a pilot simulation.\\[5mm]
\begin{algorithm}[H]
 \KwData{Scenarios for simulations of $X$ and $Y$}
 \KwResult{Estimation for $\mathrm{E}(Y)$}
 initialization\;
 assign N to be the number of simulations to do\;
 pilot simulation to obtain correlation\;
 \For {i = 1 \dots N} {
 \quad $generate(X_{i}, Y_{i})$\;
 }
 Assign $\lambda^{*} = \frac{\mathrm{Cov}(X,Y)}{\mathrm{Var}(X)} = \frac{\sum_{i=1}^{n}(X_{i}-\bar{X})(Y_{i}-\bar{Y})}{\sum_{i=1}^{n}(X_{i}-\bar{X})^{2}}$\;
 \For {i = 1 \dots N} {
	\quad $generate(X_{i}, Y_{i})$\;
	\quad set ${Y}_{i}(\lambda) = Y_{i} + \lambda^{*}(X_{i}-\mathrm{E}[X])$\;
 }
 $\bar{Y}(\lambda) = \frac{1}{n} \sum_{i=1}^{n} {Y}_{i}(\lambda)$\;
\caption{General Control Variate Algorithm}
\end{algorithm}
Here we put down the algorithm for Monte Carlo simulations of option prices using underlying prices as control variates. Denote the underlying prices by $U_{i}$, payoff function by $f$, option payoffs by $P_{i}$ and the option premium by $\bar{P}(\lambda)$.\\[5mm]
\begin{algorithm}[H]
 \KwData{Hypothetical distribution of $U$ and option payoff function $f$}
 \KwResult{Estimation for $\mathrm{E}(P)$}
 Initialization\;
 Assign N to be the number of simulations to do\;
 \For {i = 1 \dots N} {
  \quad $generate(U_{i})$\;
  \quad $P_{i} = f(U_{i})$\;
 }
 Assign $\lambda^{*} = \frac{\mathrm{Cov}(U, P)}{\mathrm{Var}(U)} = \frac{\sum_{i=1}^{n}(U_{i}-\bar{U})(P_{i}-\bar{P})}{\sum_{i=1}^{n}(U_{i}-\bar{U})^{2}}$\;
 \For {i = 1 \dots N} {
  \quad $generate(U_{i})$\;
  \quad $P_{i} = f(U_{i})$\;
  \quad set ${P}_{i}(\lambda) = P_{i} + \lambda^{*}(U_{i}-\mathrm{E}[U])$\;
 }
 $\bar{P}(\lambda) = e^{-rT}\frac{1}{n} \sum_{i=1}^{n} {P}_{i}(\lambda)$\;
\caption{Control Variate Algorithm for option pricing}
\end{algorithm}
\newpage
\subsection{Stratified Sampling}
Stratified sampling refers broadly to any sampling mechanism that constrains the fraction of observations drawn from specific subsets (or strata) of the sample space. Our goal is to estimate $\mathrm{E}[Y]$, by dividing the sample space into $n$ parts, with $A_{1}, \dots ,A_{n}$ being disjoint subsets of the real line for which $\mathrm{P}(Y \in \cup_{i}A_{i}) = 1$. \\
By Bayes$^{\prime}$ Theorem, $ \mathrm{E}[Y] = \sum_{i=1}^{n}\mathrm{P}(Y \in A_{i})\mathrm{E}[Y|Y \in A_{i}] = \sum_{i=1}^{n}p_{i}\mathrm{E}[Y|Y \in A_{i}] $\\
We shall exercise proportional sampling which is the simplest case, ensuring $p_{i} = \mathrm{P}(Y \in A_{i})$, the fraction of observations drawn from stratum $A_{i}$ exactly matches theoretical probability.\\[1mm]
Unbiased estimator of $\mathrm{E}(Y)$ is given by $\hat{Y} = \sum_{i=1}^{K} (p_{i} \frac{1}{n_{i}} \sum_{j=1}^{n_{i}} Y_{ij}) = \frac{1}{n} \sum_{i=1}^{K} \sum_{j=1}^{n_{i}} Y_{ij}$
$$ \mathrm{E}[\hat{Y}] = \mathrm{E}[\sum_{i=1}^{K} (p_{i} \frac{1}{n_{i}} \sum_{j=1}^{n_{i}} Y_{ij})] = \sum_{i=1}^{K}\mathrm{P}(Y \in A_{i})\mathrm{E}[Y|Y \in A_{i}] = \mathrm{E}[Y]$$
We shall generate a stratification variable $X$ which take values in the union of the disjoint sets $A_{i}$s. As supposedly the values of $X$ are high correlated to the values of $Y$, in many cases, $Y$ is a function of X. Let $X$ be the discrete path of underlying asset prices, with $Y$ being the European call payoff discounted to time 0. If $X$ has $h$ discrete prices on one path, $\Omega \in \mathbb{R}^{h}$ is the sample space for the $X_{i}^{\prime}$s, where $\Omega = \cup_{i} A_{i}$ is the union of disjoint sets.\\
For the purpose of stratified sampling, $\mathbb{P}(X \in A_{i})$ and $Y | X \in A_{i}$ should be easy to generate.\\
In order to further simplify the trouble of dividing $\Omega$ into disjoint subsets, we are going to use the stock prices at time $\frac{T}{2}$ as the condition to determine the distributions of $A_{i}$. The stock prices at time $\frac{T}{2}$ will be computed based on the Geometric Brownian Motion of the underlying stock prices. Given that we are to produce $n$ equally probable subsets of $\Omega$, the standard normal distribution can be sliced into $n$ pieces to provide sources of generation. With the underlying asset prices at time $\frac{T}{2}$, we can generate $k$ prices at time $T$ and calculate the respective option payoffs. The average payoffs for each stratum $A_{i}$ is then computed and discounted back to time $\frac{T}{2}$, at which we calculate the average payoffs across the stratum and discount to time $0$. \\[2mm]
\begin{algorithm}[H]
 \KwData{$N$ the number of total simulations and $f$ the payoff function}
 \KwResult{$\bar{P}$, Estimation for the option premium}
 initialization\;
 $k = \frac{N}{n}$ is the number of simulations for each stratum\;
 \For {i = 1 \dots n} {
 $z_{\alpha_{i}}$ is the quantile of standard normal distribution at probability $\frac{i}{n}$\;
 $S_{\frac{T}{2}, i} = S_{0}\exp\{(r-\frac{1}{2}\sigma^{2})\frac{T}{2} + \sigma \sqrt{\frac{T}{2}}z_{\alpha_{i}}\}$\;
 \For {j = 1 \dots k} {
 $S_{T, i, j} = S_{\frac{T}{2}, i}\exp\{(r-\frac{1}{2}\sigma^{2})\frac{T}{2} + \sigma \sqrt{\frac{T}{2}}z_{i,j}\}$\;
 $P_{T, i, j} = f(S_{T, i, j})$;
 }
 $\bar{P}_{\frac{T}{2}, i} = \frac{1}{k} e^{-r\frac{T}{2}}  \sum_{j=1}^{k} P_{T, i, j}$\;
 }
 $\bar{P} = \frac{1}{n} \sum_{i=1}^{n} \bar{P}_{\frac{T}{2}, i}$\;
\caption{General Proportional Sampling Algorithm}
\end{algorithm}
\newpage

\subsection{Importance Sampling}
Importance sampling is a method to reduce variance by changing the probability measure. The word `Importance' comes from the aim to give more weights to `important' outcomes by changing measures.\\
We are going to estimate $\displaystyle \alpha = \mathrm{E}[h(X)] = \int h(x)f(x) dx$.\\
From Monte Carlo simulations, $\displaystyle \hat{\alpha} = \hat{\alpha}(n) = \frac{1}{n} \sum_{i=1}^{n} h(X_{i})$\\
By using a change of measure based on the following assumption:
$$\forall x \in \mathbb{R}^{d}, f(x) > 0 \implies g(x) > 0$$
Now the estimate becomes $\displaystyle \alpha = \mathrm{E}[h(X)] = \mathrm{E}[h(X)\frac{f(X)}{g(X)}] = \int h(x)\frac{f(x)}{g(x)} dx$\\
As for simulation, $\displaystyle \hat{\alpha}_{G} = \frac{1}{n} \sum_{i=1}^{n} h(X_{i})\frac{f(X_{i})}{g(X_{i})}$
We are choosing $g$ to make ${X \in A}$ more likely after changing measure.\\
In order to reduce variance, we need to implicitly find the $g$ which gives the minimum possible variance. According to the variance formula $\mathrm{Var}(X) = \mathrm{E}(X^{2}) - (\mathrm{E}(X))^{2} $, we have
\begin{equation*}
\begin{split}
\mathrm{Var}^{G}[h(X)\frac{f(X)}{g(X)}] &= \mathrm{E}^{G}[h(X)^{2}\frac{f(X)^{2}}{g(X)^{2}}] - (\mathrm{E}^{G}[h(X)\frac{f(X)}{g(X)}])^{2}\\
&= \int \frac{h(x)^{2}f(x)^{2}}{g(x)} dx - (\int \frac{h(x)f(x)}{g(x)}g(x) dx)^{2}\\
\end{split}
\end{equation*}
If $\displaystyle h(x) = \frac{g(x)f(x)}{\mathrm{E}(g(x))}$, the variance of estimate will become 0.\\
Consider the scenario in which we simulate discrete price paths $S(t_{i}), \forall i = 0, 1, \dots, m$, which is assumed to be a Markov Chain with homogeneous property. Let the continuous transition probability be $f_{i}(S(t_{i-1}),S(t_{i}))$.\\[3mm]
We shall use likelihood ratio $\displaystyle \prod_{i=1}^{m} \frac{f_{i}(S(t_{i-1}),S(t_{i}))}{g_{i}(S(t_{i-1}),S(t_{i}))}$ as risk-neutral measure.
\begin{equation*}
\begin{split}
\mathbb{E}^{\mathbb{Q}}(X) 
&= \int x g(x) dx\\
&= \mathbb{E}^{\mathbb{P}}(\frac{d\mathbb{Q}}{d\mathbb{P}}X) \\
&= \mathbb{E}^{\mathbb{P}}(e^{\lambda W_{T} - \frac{1}{2}\lambda^{2}T}X) \\[7mm]
\end{split}
\end{equation*}
In the Black-Scholes world,
$$\mathbb{E}^{\mathbb{P}}((S_{T} - K)^{+})= \mathbb{E}^{\mathbb{Q}}(\frac{d\mathbb{P}}{d\mathbb{Q}}(S_{T} - K)^{+}) = \mathbb{E}^{\mathbb{Q}}(e^{((\mu - \frac{\sigma^{2}}{2}+\sigma A)T + \sigma W_{T}^{\mathbb{Q}}})(S_{T} - K)^{+})$$
Hence $\displaystyle \frac{d\mathbb{Q}}{d\mathbb{P}} = exp\{AW_{T} - \frac{1}{2}A^{2}T\}$
\newpage

\section{European call options}
\subsection{Closed-form formula}
We can derive the closed-form formula for the European call options using risk-neutral pricing.\\
Payoff function of the European call option is : $c_{T} = (S_{T} - K)^{+}$\\
By the risk-neutral pricing formula,
\begin{equation}
\begin{split}
e^{-\mu t}c_{t}
&= \mathbb{E}^{Q}[e^{-\mu T}c_{T} | \mathcal{F}_{t}]\\
&= \mathbb{E}_{t}^{Q}[e^{-\mu T}(S_{T} - K)^{+}]
\end{split}
\end{equation}
By the lognormal property, \quad
$S_{T} = S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi}$
\begin{equation}
\begin{split}
c_{t} 
&= e^{\mu t}\mathbb{E}_{t}^{Q}[e^{-rT}(S_{T} - K)^{+}]\\
&= e^{\mu t}\mathbb{E}_{t}^{Q}[e^{-rT}(S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi} - K)^{+}]\\
&= e^{-\mu \tau}\mathbb{E}^{Q}[(S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi} - K)^{+}]\\
&= e^{-\mu \tau}\int_{-\infty}^{\infty} (S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi} - K)^{+}\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}  \, d\phi \\
&= e^{-\mu \tau}\int_{-d_{2}}^{\infty} (S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi} - K)\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}  \, d\phi \\
&= e^{-\mu \tau}\int_{-d_{2}}^{\infty} S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi}\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}  \, d\phi - e^{-r\tau}\int_{-d_{2}}^{\infty} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}K\, d\phi\\
&= e^{(\mu - \frac{1}{2}\sigma^{2})\tau-\mu \tau}S_{t}\int_{-d_{2}}^{\infty} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}(\phi^{2}-2\sigma\sqrt{\tau}\phi)}  \, d\phi - Ke^{-r\tau}\int_{-d_{2}}^{\infty} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi\\
&= S_{t}\int_{-d_{2}}^{\infty} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}(\phi^{2}-2\sigma\sqrt{\tau}\phi+\sigma^{2}\tau)}  \, d\phi - Ke^{-r\tau}\int_{-\infty}^{d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi\\
&= S_{t}\int_{-d_{2}}^{\infty} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}(\phi-\sigma\sqrt{\tau}\phi)^{2}}  \, d\phi - Ke^{-r\tau}\int_{-\infty}^{d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi\\
&= S_{t}\int_{-d_{2}-\sigma\sqrt{\tau}}^{\infty} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}y^{2}}  \, dy - Ke^{-r\tau}\int_{-\infty}^{d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi\\
&= S_{t}\int_{-\infty}^{d_{2}+\sigma\sqrt{\tau}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}y^{2}}  \, dy - Ke^{-r\tau}\int_{-\infty}^{d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi\\
&= S_{t} N(d_{1}) - Ke^{-r\tau} N(d_{2})
\end{split}
\end{equation}
where,
$$d_{2} = \frac{\ln{\frac{S_{t}}{K}} + (\mu - \frac{1}{2}\sigma^{2})\tau}{\sigma\sqrt{\tau}}$$
$$d_{1} = d_{2} + \sigma\sqrt{\tau}$$
Also, $N$ is the cumulative density function of standard normal function.
\newpage
\subsection{Numerical PDE}
\newpage
\subsection{Monte Carlo Simulation}
With the following settings: $\sigma = 0.25$, $\mu = 0.05$, $T = 1$, $S_{0} = 100$, 
when we compare the results from Monte Carlo simulation with the option prices computed using the closed form formula, it is observable that a simulation with 500000 data points still has variation of error within range from $-0.02$ to $0.02$. However, this comparison has ensured that our valuation scheme using Monte Carlo simulation and the variance reduction techniques is on the right way, and may be applied onto other options.\\
A tabulation of the resultant call option prices are shown below:
\begin{center}
\begin{tabular}{|c|c|c|c|}
\hline
StrikePrice & Closed-form formula & Ordinary Monte Carlo & Control Variate\\
\hline
105&10.0022021172&10.005252032814727& 10.005252032814751\\
110&8.02638469385&8.0166707887876427& 8.016670788787664\\ 
115&6.37924904693&6.3659464432937911& 6.3659464432937733\\ 
120&5.02541348179&5.0148870431746415& 5.0148870431746184\\
125&3.92690420603&3.9241698581683577& 3.9241698581683728\\
130&3.04592058431&3.044679765401427&  3.0446797654014213\\
135&2.34679877596&2.3310307686205207& 2.3310307686205225\\
140&1.79723400902&1.8055531375480696& 1.8055531375480751\\
145&1.36889248498&1.3630119824610754& 1.3630119824610734\\
150&1.03756650489&1.0254470920297398& 1.0254470920297361\\
155&0.783018613011&0.77819086371547286&0.77819086371547308\\
160&0.588637155719&0.5924848566970754& 0.59248485669707973\\
165&0.440997057228&0.44342591182216823&0.4434259118221664\\
170&0.329392108384&0.32449718396190719&0.32449718396190735\\
175&0.245381782063&0.2462392632801686& 0.24623926328016907\\
180&0.182377553986&0.17995020687354496&0.1799502068735449\\
185&0.13528073067&0.13478417666883458&0.13478417666883413\\
190&0.100175092579&0.099449778570450814&0.099449778570450523\\
195&0.0740722950356&0.074452813719303179&0.074452813719303304\\
200&0.0547050187389&0.051631534936688268&0.051631534936688074\\
\hline
\end{tabular}
\end{center}
\newpage

\section{European put options}

\subsection{Closed-form formula}
We can derive the closed-form formula for the European put options using risk-neutral pricing.\\
Payoff function of the European put option is : $p_{T} = (K - S_{T})^{+}$\\
By the risk-neutral pricing formula,
\begin{equation}
\begin{split}
e^{-\mu t}p_{t}
&= \mathbb{E}^{Q}[e^{-\mu T}p_{T} | \mathcal{F}_{t}]\\
&= \mathbb{E}_{t}^{Q}[e^{-\mu T}(K - S_{T})^{+}]
\end{split}
\end{equation}
By the lognormal property, \quad
$S_{T} = S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi}$
\begin{equation}
\begin{split}
p_{t} 
&= e^{\mu t}\mathbb{E}_{t}^{Q}[e^{-rT}(K - S_{T})^{+}]\\
&= e^{\mu t}\mathbb{E}_{t}^{Q}[e^{-rT}(K - S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi})^{+}]\\
&= e^{-\mu \tau}\mathbb{E}^{Q}[(K - S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi})^{+}]\\
&= e^{-\mu \tau}\int_{-\infty}^{\infty} (K - S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi})^{+}\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}  \, d\phi \\
&= e^{-\mu \tau}\int_{-\infty}^{-d_{2}} (K - S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi})\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}  \, d\phi \\
&= e^{-r\tau}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}K\, d\phi -e^{-\mu \tau}\int_{-\infty}^{-d_{2}} S_{t}e^{(\mu - \frac{1}{2}\sigma^{2})\tau + \sigma\sqrt{\tau}\phi}\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}  \, d\phi\\
&= Ke^{-r\tau}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi - e^{(\mu - \frac{1}{2}\sigma^{2})\tau-\mu \tau}S_{t}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}(\phi^{2}-2\sigma\sqrt{\tau}\phi)}  \, d\phi\\
&= Ke^{-r\tau}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi - S_{t}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}(\phi^{2}-2\sigma\sqrt{\tau}\phi+\sigma^{2}\tau)}  \, d\phi\\
&= Ke^{-r\tau}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi - S_{t}\int_{-\infty}^{-d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}(\phi-\sigma\sqrt{\tau}\phi)^{2}}  \, d\phi\\
&= Ke^{-r\tau}\int_{-\infty}^{d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi - S_{t}\int_{-\infty}^{-d_{2}-\sigma\sqrt{\tau}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}y^{2}}  \, dy\\
&= Ke^{-r\tau}\int_{-\infty}^{d_{2}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}\phi^{2}}\, d\phi - S_{t}\int_{-\infty}^{-d_{1}} \frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}y^{2}}  \, dy \\
&= Ke^{-r\tau} N(-d_{2}) - S_{t} N(-d_{1})
\end{split}
\end{equation}
where,
$$d_{2} = \frac{\ln{\frac{S_{t}}{K}} + (\mu - \frac{1}{2}\sigma^{2})\tau}{\sigma\sqrt{\tau}}$$
$$d_{1} = d_{2} + \sigma\sqrt{\tau}$$
Also, $N$ is the cumulative density function of standard normal function.
\newpage
\subsection{Numerical PDE}
\newpage
\subsection{Monte Carlo Simulation}
With the following settings: $\sigma = 0.25$, $\mu = 0.05$, $T = 1$, $S_{0} = 100$, 
when we compare the results from Monte Carlo simulation with the option prices computed using the closed form formula, it is observable that a simulation with 500000 data points still has variation of error within range from $-0.02$ to $0.02$. However, this comparison has ensured that our valuation scheme using Monte Carlo simulation and the variance reduction techniques is on the right way, and may be applied onto other options.\\
A tabulation of the resultant option prices are shown below:
\begin{center}
\begin{tabular}{|c|c|c|c|}
\hline
StrikePrice & Closed-form formula & Ordinary Monte Carlo & Control Variate\\
\hline
105&9.88129168973 &9.89121100448 & 9.89121100448 \\
110&12.6616213889 &12.6718073072 & 12.6718073072 \\
115&15.7706328645 &15.7786013449 & 15.7786013449 \\
120&19.1729444219 &19.1488969419 & 19.1488969419 \\
125&22.8305822686 &22.8396769379 & 22.8396769379 \\
130&26.7057457694 &26.7349375768 & 26.7349375768 \\
135&30.7627710836 &30.7487677853 & 30.7487677853 \\
140&34.9693534391 &34.9407041949 & 34.9407041949 \\
145&39.2971590376 &39.3339188168 & 39.3339188168 \\
150&43.72198018 &  43.6672929866 & 43.6672929866 \\
155&48.2235794106 &48.2561306956 & 48.2561306956 \\
160&52.7853450758 &52.7364667849 & 52.7364667849 \\
165&57.3938520998 &57.3635053884 & 57.3635053884 \\
170&62.0383942735 &62.0538619165 & 62.0538619165 \\
175&66.7105310697 &66.7099933687 & 66.7099933687 \\
180&71.4036739641 &71.3460094069 & 71.3460094069 \\
185&76.1127242633 &76.1619698093 & 76.1619698093 \\
190&80.8337657477 &80.8390739688 & 80.8390739688 \\
195&85.5638100727 &85.5359768969 & 85.5359768969 \\
200&90.3005899189 &90.2678714265 & 90.2678714265 \\
\hline
\end{tabular}
\end{center}
\newpage

\section{Barrier option}
The continuous barrier option is one of the most frequently traded path-dependent options. This option comes with a same payoff function as the normal European call/put at maturity subject to the additional condition for a prescribed level to be crossed or not by the underlying asset price during the life of option. The barrier options can be categorized into four different types with the name down-and-out, down-and-in, up-and-out, up-and-in.
\subsection{Joint distribution of Minimum and Terminal Value}
We define the minimum value $\displaystyle m_{T} = \min_{0 \le t \le T} \ln{\frac{S_{t}}{S_{0}}}$ and the terminal value $x_{T} = \ln{\frac{S_{T}}{S_{0}}}$.\\
\begin{corollary}
$$\mathbb{P}(X_{T} \ge x, m_{T} \ge m) = N(\frac{\mu T - x}{\sigma \sqrt{T}}) - e^{\frac{2\mu m}{\sigma^{2}}}N(\frac{2m-x+\mu T}{\sigma \sqrt{T}})$$
\end{corollary}
\begin{corollary}
$$\mathbb{P}(m_{T} \ge m) = N(\frac{\mu T - m}{\sigma \sqrt{T}}) - e^{\frac{2\mu m}{\sigma^{2}}}N(\frac{m+\mu T}{\sigma \sqrt{T}})$$
\end{corollary}
Details of the proofs for the two corollaries are omitted here.
\newpage

\subsection{Closed-form formula}
The payoff function of a down-and-out call option can express as $(S_{T} - K)\mathbbm{1}_{\mathbb{F}}$, where $\mathbbm{1}_{\mathbb{F}}$ is the indicator variable for the payoff to be non-zero, as $\displaystyle \mathbb{F} = \{ S_{T} \ge K, \min_{0 \le t \le T} S_{t} \ge B \}$\\[1mm]
For risk-neutral valuation, we split the payoff in order to apply the Change of Numeraire Theorem where appropriate. Let $V_{T}^{(1)} = S_{T}\mathbbm{1}_{\mathbb{F}}$, $V_{T}^{(2)} =  K\mathbbm{1}_{\mathbb{F}}$, with the assumption that there is no dividend yield, we can express the option price as such:
\begin{equation*}
\begin{split}
c_{do}(S, B, K)
&= e^{-rT}\mathbb{E}^{\mathbb{Q}}[(S_{T} - K)\mathbbm{1}_{\mathbb{F}}]\\
&= e^{-rT}\mathbb{E}^{\mathbb{Q}}(S_{T}\mathbbm{1}_{\mathbb{F}}) - e^{-rT}\mathbb{E}^{\mathbb{Q}}(K\mathbbm{1}_{\mathbb{F}})\\
&= e^{-rT}\mathbb{E}^{\mathbb{Q}}(V_{T}^{(1)}) - e^{-rT}\mathbb{E}^{\mathbb{Q}}(V_{T}^{(2)})\\
&= \mathbb{E}^{\mathbb{Q}}[\frac{V_{T}^{(1)}}{M_{T}}] - \mathbb{E}^{\mathbb{Q}}[\frac{V_{T}^{(2)}}{M_{T}}] = \frac{V_{0}^{(1)}}{M_{0}} - \frac{V_{0}^{(2)}}{M_{0}} = V_{0}^{(1)} - V_{0}^{(2)}
\end{split}
\end{equation*}
We can now use the stock measure $\mathbb{Q}^{S}$ on $V_{0}^{(1)}$ and the risk-neutral measure $\mathbb{Q}$ on $V_{0}^{(2)}$.\\
By the Change of Numeraire Theorem, $\frac{V_{0}^{(1)}}{S_{0}} = \mathbb{E}^{\mathbb{Q}^{S}}[\frac{V_{T}^{(1)}}{S_{T}}]$, $\frac{V_{0}^{(2)}}{M_{0}} = \mathbb{E}^{\mathbb{Q}^{S}}[\frac{V_{T}^{(2)}}{M_{T}}]$\\
$$V_{0}^{(1)} = S_{0}\mathbb{E}^{\mathbb{Q}^{S}}[\frac{V_{T}^{(1)}}{S_{T}}] = S_{0}\mathbb{E}^{\mathbb{Q}^{S}}[\frac{S_{T}\mathbbm{1}_{\mathbb{F}}}{S_{T}}] = S_{0}\mathbb{E}^{\mathbb{Q}^{S}}(\mathbbm{1}_{\mathbb{F}}) = S_{0}\mathbb{Q}^{S}({\mathbb{F}})$$
$$V_{0}^{(2)} = M_{0}\mathbb{E}^{\mathbb{Q}}[\frac{V_{T}^{(2)}}{M_{T}}] = M_{0}\mathbb{E}^{\mathbb{Q}}[\frac{K\mathbbm{1}_{\mathbb{F}}}{M_{T}}] = \frac{K}{M_{T}}\mathbb{E}^{\mathbb{Q}}(\mathbbm{1}_{\mathbb{F}}) = e^{-rT}K\mathbb{Q}({\mathbb{F}})$$
For the case that $K > B$,
\begin{equation*}
\begin{split}
\mathbb{F}
&= \{ S_{T} \ge K, \min_{0 \le t \le T} S_{t} \ge B \} = \{ \ln{S_{T}} \ge \ln{K}, \min_{0 \le t \le T} \ln{S_{t}} \ge ln{B} \}\\
&= \{ \ln{S_{T}} - \ln{S_{0}} \ge \ln{K} - \ln{S_{0}}, \min_{0 \le t \le T} \ln{S_{t}} - \ln{S_{0}} \ge \ln{B} - \ln{S_{0}} \}\\
&= \{ \ln{\frac{S_{T}}{S_{0}}} \ge \ln{\frac{K}{S_{0}}}, \min_{0 \le t \le T} \ln{\frac{S_{t}}{S_{0}}} \ge \ln{\frac{B}{S_{0}}} \}
\end{split}
\end{equation*}
We can now let $\displaystyle x_{T} = \ln{\frac{S_{T}}{S_{0}}}$, $\displaystyle m_{T} = \min_{0 \le t \le T} \ln{\frac{S_{t}}{S_{0}}}$, $\displaystyle x = \ln{(\frac{K}{S_{0}})}$, $\displaystyle m = \ln{(\frac{B}{S_{0}})}$\\[1mm]
and apply Corollary 1 to solve for $\mathbb{Q}^{S}(\mathbb{F})$ with $\mu = r + \frac{\sigma^{2}}{2}$.\\
\begin{equation*}
\begin{split}
V_{0}^{(1)}
&= S_{0}\mathbb{Q}^{S}({\mathbb{F}}) = S_{0}\mathbb{Q}^{S}(x_{T} \ge x, m_{T} \ge m)\\
&= S_{0}\{ N(\frac{(r+\frac{\sigma^{2}}{2})T - \ln{(\frac{K}{S_{0}})}}{\sigma \sqrt{T}}) - e^{\frac{2(r+\frac{\sigma^{2}}{2})}{\sigma^{2}}\ln{(\frac{B}{S_{0}})}} N(\frac{2\ln{(\frac{B}{S_{0}})} - \ln{(\frac{K}{S_{0}})} + (r + \frac{\sigma^{2}}{2})T}{\sigma \sqrt{T}}) \}\\
&= S_{0}\{ N(\frac{(r+\frac{\sigma^{2}}{2})T + \ln{(\frac{S_{0}}{K})}}{\sigma \sqrt{T}}) - {(\frac{B}{S_{0}})}^{\frac{2r}{\sigma^{2}}+1} N(\frac{\ln{(\frac{B^{2}}{S_{0}K})} + (r + \frac{\sigma^{2}}{2})T}{\sigma \sqrt{T}}) \}\\
&= S_{0}\{ N(d_{1}) - {(\frac{B}{S_{0}})}^{\frac{2r}{\sigma^{2}}+1} N(d_{2}) \}
\end{split}
\end{equation*}
\newpage
Similarly, we can express $V_{0}^{(2)}$ as $e^{-rT}K\mathbb{Q}({\mathbb{F}})$, and apply Corollary 1 with to solve for $\mathbb{Q}(\mathbb{F})$ with $\mu = r - \frac{\sigma^{2}}{2}$.\\
\begin{equation*}
\begin{split}
V_{0}^{(2)}
&= e^{-rT}K\mathbb{Q}({\mathbb{F}}) = e^{-rT}K\mathbb{Q}(x_{T} \ge x, m_{T} \ge m)\\
&= e^{-rT}K\{ N(\frac{(r-\frac{\sigma^{2}}{2})T - \ln{(\frac{K}{S_{0}})}}{\sigma \sqrt{T}}) - e^{\frac{2(r-\frac{\sigma^{2}}{2})}{\sigma^{2}}\ln{{(\frac{B}{S_{0}})}}} N(\frac{2\ln{\frac{B}{S_{0}} - \ln{\frac{K}{S_{0}}} + (r - \frac{\sigma^{2}}{2})T}}{\sigma \sqrt{T}}) \}\\
&= e^{-rT}K\{ N(\frac{(r-\frac{\sigma^{2}}{2})T + \ln{(\frac{S_{0}}{K})}}{\sigma \sqrt{T}}) - {(\frac{B}{S_{0}})}^{\frac{2r}{\sigma^{2}}-1} N(\frac{\ln{(\frac{B^{2}}{S_{0}K})} + (r - \frac{\sigma^{2}}{2})T}{\sigma \sqrt{T}}) \}\\
&= e^{-rT}K\{ N(d_{3}) - {(\frac{B}{S_{0}})}^{\frac{2r}{\sigma^{2}}-1} N(d_{4}) \}
\end{split}
\end{equation*}
\\For the case that $K > B$, the situation is simplied as the condition $S_{T} \ge K$ is redundant. The new condition $\mathbb{F}^{\prime} = \displaystyle \{ \min_{0 \le t \le T} S_{t} \ge B \}$, with the payoff function being $(S_{T} - K)\mathbbm{1}_{\{ \min_{0 \le t \le T} S_{t} \ge B \}}$.\\
We shall apply Corollary 2 to solve for $\mathbb{Q}^{S}(\mathbb{F}^{\prime})$ in this case with $\mu = r + \frac{\sigma^{2}}{2}$, $\displaystyle m_{T} = \min_{0 \le t \le T} \ln{\frac{S_{t}}{S_{0}}}$.\\
\begin{equation*}
\begin{split}
V_{0}^{(1)}
&= S_{0}\mathbb{Q}^{S}({\mathbb{F}}^{\prime}) = S_{0}\mathbb{Q}^{S}(m_{T} \ge m)\\
&= S_{0}\{ N(\frac{(r+\frac{\sigma^{2}}{2})T - \ln{(\frac{B}{S_{0}})}}{\sigma \sqrt{T}}) - e^{\frac{2(r+\frac{\sigma^{2}}{2})}{\sigma^{2}}\ln{(\frac{B}{S_{0}})}} N(\frac{\ln{\frac{B}{S_{0}} + (r + \frac{\sigma^{2}}{2})T}}{\sigma \sqrt{T}}) \}\\
&= S_{0}\{ N(\frac{(r+\frac{\sigma^{2}}{2})T + \ln{(\frac{S_{0}}{B})}}{\sigma \sqrt{T}}) - {(\frac{B}{S_{0}})}^{\frac{2r}{\sigma^{2}}+1} N(\frac{\ln{(\frac{B}{S_{0}})} + (r + \frac{\sigma^{2}}{2})T}{\sigma \sqrt{T}}) \}\\
&= S_{0}\{ N(d_{5}) - {(\frac{B}{S_{0}})}^{\frac{2r}{\sigma^{2}}+1} N(d_{6}) \}
\end{split}
\end{equation*}
We can also apply Corollary 2 to solve for $\mathbb{Q}(\mathbb{F}^{\prime})$ in this case with $\mu = r - \frac{\sigma^{2}}{2}$.
\begin{equation*}
\begin{split}
V_{0}^{(2)}
&= e^{-rT}K\mathbb{Q}({\mathbb{F}^{\prime}})\\
&= e^{-rT}K\mathbb{Q}(m_{T} \ge m)\\
&= e^{-rT}K\{ N(\frac{(r-\frac{\sigma^{2}}{2})T - \ln{(\frac{B}{S_{0}})}}{\sigma \sqrt{T}}) - e^{\frac{2(r-\frac{\sigma^{2}}{2})}{\sigma^{2}}\ln{{(\frac{B}{S_{0}})}}} N(\frac{2\ln{\frac{B}{S_{0}} - \ln{\frac{K}{S_{0}}} + (r - \frac{\sigma^{2}}{2})T}}{\sigma \sqrt{T}}) \}\\
&= e^{-rT}K\{ N(\frac{(r-\frac{\sigma^{2}}{2})T + \ln{(\frac{S_{0}}{B})}}{\sigma \sqrt{T}}) - {(\frac{B}{S_{0}})}^{\frac{2r}{\sigma^{2}}-1} N(\frac{\ln{(\frac{B}{S_{0}})} + (r - \frac{\sigma^{2}}{2})T}{\sigma \sqrt{T}}) \}\\
&= e^{-rT}K\{ N(d_{7}) - {(\frac{B}{S_{0}})}^{\frac{2r}{\sigma^{2}}-1} N(d_{8}) \}
\end{split}
\end{equation*}
Conclusively, 
\begin{equation*}
c_{do}(S_{0}, B, K) = 
\begin{cases}
c(S_{0}, K) - {(\frac{B}{S_{0}})}^{\frac{2r}{\sigma^{2}}+1} c(\frac{B^{2}}{S_{0}}, K) \text{, if }K > B\\
S_{0}\{ N(d_{5}) - {(\frac{B}{S_{0}})}^{\frac{2r}{\sigma^{2}}+1} N(d_{6})\} - e^{-rT}K\{ N(d_{7}) - {(\frac{B}{S_{0}})}^{\frac{2r}{\sigma^{2}}-1} N(d_{8})\} \text{, if }K \le B\\
\end{cases}
\end{equation*}
\begin{center}
where $c(S_{0}, K, T)$ denotes the European call option premium\\ with initial stock price $S_{0}$, strike price $K$.
\end{center}
\newpage
\subsection{Numerical PDE}
\newpage
\subsection{Monte Carlo Simulation}
A full valuation of the continuous Barrier option will require the usage of the closed-form formula. In the case of pricing a down-and-out call option, discrete Monte Carlo valuation scheme will always give a price higher than the right price as there will always be scenarios missed in which the barrier to be breached. Still, even if we can find an increment in the time zone which can make the scenarios missed to be negligible, the computation cost will increase rapidly and we will not be able to generate enough data points for the accuracy of the estimated option price. Upon this predicament, the research results of Professor Steven Kou shed light on this problem as to give a multiplier to the barrier to enable the discrete valuation of the continuous Barrier option. As the results have been proven both in theory and in practice, we are convinced that the correct pricing can be obtained.
\\
A tabulation of the resultant down-and-out call option prices are shown below, with the leftmost column indicating the strike prices and the uppermost row indicating the barriers, proving that this valuation scheme can be exercised on the path-dependent options:
\begin{center}
\begin{tabular}{|c|c|c|c|}
\hline 
 & 75 & 85 & 95\\
\hline
70&31.970666152&25.1858706232&10.5704766084\\
80&24.6583030035&20.3399767413&8.8991939912\\
90&17.8621463707&15.5108745676&7.2279113741\\
100&12.2374796697&11.0529331703&5.5619564416\\
110&7.9924835933&7.4269559884&4.0150057856\\
120&5.013923987&4.7541407506&2.7398001805\\
130&3.0420520393&2.9259014547&1.7834515724\\
140&1.7959318431&1.7449454877&1.1168039009\\
150&1.0371263472&1.0150077571&0.677741966\\
160&0.5884872655&0.5789572677&0.4010785064\\
\hline
\end{tabular}
\\[1mm]Correct prices from closed-form formula
\\[3mm]
\begin{tabular}{|c|c|c|c|}
\hline
 & 75 & 85 & 95\\
\hline
70&31.9342389613&25.2939954452&10.4494113445\\
80&24.7360739924&20.3406635302&8.9096699675\\
90&17.9471968708&15.5171519681&7.1210238083\\
100&12.2479562769&11.0524462206&5.6074949358\\
110&7.9837204154&7.4377240674&3.9666377603\\
120&5.1471035605&4.784715893&2.8406115503\\
130&3.0118119801&2.9283119044&1.8069967242\\
140&1.8041308385&1.6956803311&1.1583686103\\
150&1.0271540107&1.0270140515&0.6942016255\\
160&0.6183921248&0.5631658807&0.3880185991\\
\hline
\end{tabular}
\\[1mm] Resultant prices from Monte Carlo simulations
\end{center}
We can see from the simulation results that this valuation scheme should be consistent, and the accuracy of the estimate is unaffected by the change in parameters. This gives us confidence that with the advancement of GPU and parallel computing, we should be able to generate more accurate results for other path-dependent options using this scheme.
\newpage

\end{document}